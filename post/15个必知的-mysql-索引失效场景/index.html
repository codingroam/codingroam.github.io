<!doctype html><html lang=zh-cn dir=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>15个必知的 Mysql 索引失效场景 - 想学啊你</title><meta name=keywords content="博客"><meta name=author content="roam"><meta property="og:title" content="15个必知的 Mysql 索引失效场景"><meta property="og:site_name" content="想学啊你"><meta property="og:image" content="https://codingroam.github.io/img/author.jpg"><meta name=title content="15个必知的 Mysql 索引失效场景 - 想学啊你"><meta name=description content="轻轻的你来了"><link rel="shortcut icon" href=https://codingroam.github.io/img/favicon.ico><link rel=apple-touch-icon href=https://codingroam.github.io/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://codingroam.github.io/img/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=https://codingroam.github.io/css/main.css rel=stylesheet type=text/css><link href=https://codingroam.github.io/css/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-Hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>想学啊你</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>三四楼那么高了</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class=menu-item><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-book"></i><br>分类</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://codingroam.github.io/post/15%E4%B8%AA%E5%BF%85%E7%9F%A5%E7%9A%84-mysql-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/ itemprop=url>15个必知的 Mysql 索引失效场景</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2023-08-23">2023-08-23</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/mysql itemprop=url rel=index><span itemprop=name>Mysql</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>5579 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>12分钟</span></span>
<span id=/post/15%E4%B8%AA%E5%BF%85%E7%9F%A5%E7%9A%84-mysql-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/ class="leancloud_visitors post-visitor" data-flag-title="15个必知的 Mysql 索引失效场景"><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><p>函数参数值传递问题</p><h2 id=数据库及索引准备>数据库及索引准备</h2><h3 id=创建表结构>创建表结构</h3><p>为了逐项验证索引的使用情况，我们先准备一张表 t_user：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t_user<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>id<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#a2f>int</span>(<span style=color:#666>11</span>)<span style=color:#bbb> </span>unsigned<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb> </span>AUTO_INCREMENT<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COMMENT</span><span style=color:#bbb> </span><span style=color:#b44>&#39;ID&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>id_no<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#a2f>varchar</span>(<span style=color:#666>18</span>)<span style=color:#bbb> </span><span style=color:#a2f>CHARACTER</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>SET</span><span style=color:#bbb> </span>utf8mb4<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8mb4_bin<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COMMENT</span><span style=color:#bbb> </span><span style=color:#b44>&#39;身份编号&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>username<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#a2f>varchar</span>(<span style=color:#666>32</span>)<span style=color:#bbb> </span><span style=color:#a2f>CHARACTER</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>SET</span><span style=color:#bbb> </span>utf8mb4<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8mb4_bin<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COMMENT</span><span style=color:#bbb> </span><span style=color:#b44>&#39;用户名&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>age<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#a2f>int</span>(<span style=color:#666>11</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COMMENT</span><span style=color:#bbb> </span><span style=color:#b44>&#39;年龄&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>create_time<span style=color:#666>`</span><span style=color:#bbb> </span>datetime<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COMMENT</span><span style=color:#bbb> </span><span style=color:#b44>&#39;创建时间&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>KEY</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>id<span style=color:#666>`</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>KEY</span><span style=color:#bbb> </span><span style=color:#666>`</span>union_idx<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>id_no<span style=color:#666>`</span>,<span style=color:#666>`</span>username<span style=color:#666>`</span>,<span style=color:#666>`</span>age<span style=color:#666>`</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>KEY</span><span style=color:#bbb> </span><span style=color:#666>`</span>create_time_idx<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>create_time<span style=color:#666>`</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span>ENGINE<span style=color:#666>=</span>InnoDB<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span>CHARSET<span style=color:#666>=</span>utf8mb4<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#666>=</span>utf8mb4_bin;<span style=color:#bbb>
</span></span></span></code></pre></div><p>在上述表结构中有三个索引：</p><ul><li><code>id</code>：为数据库主键；</li><li><code>union_idx</code>：为 id_no、username、age 构成的联合索引；</li><li><code>create_time_idx</code>：是由 create_time 构成的普通索引；</li></ul><h3 id=初始化数据>初始化数据</h3><p>初始化数据分两部分：基础数据和批量导入数据。</p><p>基础数据 insert 了 4 条数据，其中第 4 条数据的创建时间为未来的时间，用于后续特殊场景的验证：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#a2f;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>INTO</span><span style=color:#bbb> </span><span style=color:#666>`</span>t_user<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>id<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>id_no<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>username<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>age<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>create_time<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#800>null</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;1001&#39;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;Tom1&#39;</span>,<span style=color:#bbb> </span><span style=color:#666>11</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;2022-02-27 09:04:23&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>INTO</span><span style=color:#bbb> </span><span style=color:#666>`</span>t_user<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>id<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>id_no<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>username<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>age<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>create_time<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#800>null</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;1002&#39;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;Tom2&#39;</span>,<span style=color:#bbb> </span><span style=color:#666>12</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;2022-02-26 09:04:23&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>INTO</span><span style=color:#bbb> </span><span style=color:#666>`</span>t_user<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>id<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>id_no<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>username<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>age<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>create_time<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#800>null</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;1003&#39;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;Tom3&#39;</span>,<span style=color:#bbb> </span><span style=color:#666>13</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;2022-02-25 09:04:23&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>INTO</span><span style=color:#bbb> </span><span style=color:#666>`</span>t_user<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>id<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>id_no<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>username<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>age<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>create_time<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#800>null</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;1004&#39;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;Tom4&#39;</span>,<span style=color:#bbb> </span><span style=color:#666>14</span>,<span style=color:#bbb> </span><span style=color:#b44>&#39;2023-02-25 09:04:23&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>除了基础数据，还有一条存储过程及其调用的 SQL，方便批量插入数据，用来验证数据比较多的场景：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#080;font-style:italic>-- 删除历史存储过程
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>DROP</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>PROCEDURE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>IF</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>EXISTS</span><span style=color:#bbb> </span><span style=color:#666>`</span>insert_t_user<span style=color:#666>`</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span>​</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic>-- 创建存储过程
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>delimiter</span><span style=color:#bbb> </span><span>$</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span>​</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>PROCEDURE</span><span style=color:#bbb> </span>insert_t_user(<span style=color:#a2f;font-weight:700>IN</span><span style=color:#bbb> </span>limit_num<span style=color:#bbb> </span><span style=color:#a2f>int</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>BEGIN</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>DECLARE</span><span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#a2f>INT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#666>10</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>DECLARE</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f>varchar</span>(<span style=color:#666>18</span>)<span style=color:#bbb> </span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>DECLARE</span><span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#a2f>varchar</span>(<span style=color:#666>32</span>)<span style=color:#bbb> </span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>DECLARE</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span>TINYINT<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span>WHILE<span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span>limit_num<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DO</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>SET</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>CONCAT(<span style=color:#b44>&#34;NO&#34;</span>,<span style=color:#bbb> </span>i);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>SET</span><span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>CONCAT(<span style=color:#b44>&#34;Tom&#34;</span>,i);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>SET</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>FLOOR(<span style=color:#666>10</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>RAND()<span style=color:#666>*</span><span style=color:#666>2</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>INTO</span><span style=color:#bbb> </span><span style=color:#666>`</span>t_user<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb> </span>id_no,<span style=color:#bbb> </span>username,<span style=color:#bbb> </span>age,<span style=color:#bbb> </span>NOW());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>SET</span><span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span> </span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>END</span><span style=color:#bbb> </span>WHILE;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span>​</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>END</span><span style=color:#bbb> </span><span>$</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic>-- 调用存储过程
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>call</span><span style=color:#bbb> </span>insert_t_user(<span style=color:#666>100</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>关于存储过程的创建和存储，可暂时不执行，当用到时再执行。</p><h3 id=数据库版本及执行计划>数据库版本及执行计划</h3><p>查看当前数据库的版本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>version</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#666>8</span>.<span style=color:#666>0</span>.<span style=color:#666>18</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>上述为本人测试的数据库版本：<code>8.0.18</code>。当然，以下的所有示例，大家可在其他版本进行执行验证。</p><p>查看 SQL 语句执行计划，一般我们都采用<code>explain</code>关键字，通过执行结果来判断索引使用情况。</p><p>执行示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>执行结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823232831150.png alt=image-20230823232831150></p><p>可以看到上述 SQL 语句使用了主键索引（PRIMARY），<code>key_len</code>为 4；</p><p>其中<code>key_len</code>的含义为：表示索引使用的字节数，根据这个值可以判断索引的使用情况，特别是在组合索引的时候，判断该索引有多少部分被使用到非常重要。</p><p>做好以上数据及知识的准备，下面就开始讲解具体索引失效的实例了。</p><h2 id=1-联合索引不满足最左匹配原则>1 联合索引不满足最左匹配原则</h2><p>联合索引遵从最左匹配原则，顾名思义，<strong>在联合索引中，最左侧的字段优先匹配</strong>。因此，在创建联合索引时，where 子句中使用最频繁的字段放在组合索引的最左侧。</p><p>而在查询时，要想让查询条件走索引，则需满足：最左边的字段要出现在查询条件中。</p><p>实例中，<code>union_idx</code>联合索引组成：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>KEY</span><span style=color:#bbb> </span><span style=color:#666>`</span>union_idx<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>id_no<span style=color:#666>`</span>,<span style=color:#666>`</span>username<span style=color:#666>`</span>,<span style=color:#666>`</span>age<span style=color:#666>`</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><p>最左边的字段为 id_no，一般情况下，只要保证 id_no 出现在查询条件中，则会走该联合索引。</p><p><strong>示例一</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;1002&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823232859286.png alt=image-20230823232859286></p><p>通过 explain 执行结果可以看出，上述 SQL 语句走了<code>union_idx</code>这条索引。</p><p>这里再普及一下 key_len 的计算：</p><ul><li><code>id_no</code> 类型为 varchar(18)，字符集为 utf8mb4_bin，也就是使用 4 个字节来表示一个完整的 UTF-8。此时，key_len = 18* 4 = 72；</li><li>由于该字段类型 varchar 为变长数据类型，需要再额外添加 2 个字节。此时，key_len = 72 + 2 = 74；</li><li>由于该字段运行为 NULL（default NULL），需要再添加 1 个字节。此时，key_len = 74 + 1 = 75；</li></ul><p>上面演示了 key_len 一种情况的计算过程，后续不再进行逐一推演，知道基本组成和原理即可，更多情况大家可自行查看。</p><p><strong>示例二</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;1002&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>and</span><span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;Tom2&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823232928340.png alt=image-20230823232928340></p><p>很显然，依旧走了<code>union_idx</code>索引，根据上面 key_len 的分析，大胆猜测，在使用索引时，不仅使用了<code>id_no</code>列，还使用了<code>username</code>列。</p><p><strong>示例三</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;1002&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>and</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>12</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823232946646.png alt=image-20230823232946646></p><p>走了<code>union_idx</code>索引，但跟示例一一样，只用到了<code>id_no</code>列。</p><p>当然，还有三列都在查询条件中的情况，就不再举例了。上面都是走索引的正向例子，也就是满足<code>最左匹配原则</code>的例子，下面来看看，不满足该原则的反向例子。</p><p><strong>反向示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;Tom2&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>and</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>12</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233004065.png alt=image-20230823233004065></p><p>此时，可以看到未走任何索引，也就是说索引失效了。</p><p>同样的，下面只要没出现最左条件的组合，索引也是失效的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>12</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;Tom2&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>那么，第一种索引失效的场景就是：<strong>在联合索引的场景下，查询条件不满足最左匹配原则</strong>。</p><h2 id=2-使用了-select->2 使用了 select *</h2><p>在《阿里巴巴开发手册》的 <strong>ORM 映射</strong>章节中有一条【强制】的规范：</p><blockquote><p>【强制】在表查询中，一律不要使用 * 作为查询的字段列表，需要哪些字段必须明确写明。 说明: 1) 增加查询分析器解析成本。2) 增减字段容易与 resultMap 配置不一致。3) 无用字段增加网络 消耗，尤其是 text 类型的字段。</p></blockquote><p>虽然在规范手册中没有提到索引方面的问题，但禁止使用<code>select *</code> 语句可能会带来的附带好处就是：某些情况下可以走<code>覆盖索引</code>。</p><p>比如，在上面的联合索引中，如果查询条件是 age 或 username，当使用了<code>select *</code> ，肯定是不会走索引的。</p><p>但如果希望根据 username 查询出 id_no、username、age 这三个结果（均为索引字段），明确查询结果字段，是可以走<code>覆盖索引</code>的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span>id_no,<span style=color:#bbb> </span>username,<span style=color:#bbb> </span>age<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;Tom2&#39;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span>id_no,<span style=color:#bbb> </span>username,<span style=color:#bbb> </span>age<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>age<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>12</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233024096.png alt=image-20230823233024096></p><p>无论查询条件是<code>username</code>还是<code>age</code>，都走了索引，根据 key_len 可以看出使用了索引的所有列。</p><p>第二种索引失效场景：<strong>在联合索引下，尽量使用明确的查询列来趋向于走覆盖索引</strong>；</p><p>这一条不走索引的情况属于优化项，如果业务场景满足，则进来促使 SQL 语句走索引。至于阿里巴巴开发手册中的规范，只不过是两者撞到一起了，规范本身并不是为这条索引规则而定的。</p><h2 id=3-索引列参与运算>3 索引列参与运算</h2><p>直接来看示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233044466.png alt=image-20230823233044466></p><p>可以看到，即便 id 列有索引，由于进行了计算处理，导致无法正常走索引。</p><p>针对这种情况，其实不单单是索引的问题，还会增加数据库的计算负担。就以上述 SQL 语句为例，数据库需要全表扫描出所有的 id 字段值，然后对其计算，计算之后再与参数值进行比较。如果每次执行都经历上述步骤，性能损耗可想而知。</p><p>建议的使用方式是：先在内存中进行计算好预期的值，或者在 SQL 语句条件的右侧进行参数值的计算。</p><p>针对上述示例的优化如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#080;font-style:italic>-- 内存计算，得知要查询的id为1
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic>-- 参数侧计算
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>第三种索引失效情况：<strong>索引列参与了运算，会导致全表扫描，索引失效</strong>。</p><h2 id=4-索引列参使用了函数>4 索引列参使用了函数</h2><p>示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>SUBSTR(id_no,<span style=color:#666>1</span>,<span style=color:#666>3</span>)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;100&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233101591.png alt=image-20230823233101591></p><p>上述示例中，索引列使用了函数（SUBSTR，字符串截取），导致索引失效。</p><p>此时，索引失效的原因与第三种情况一样，都是因为数据库要先进行全表扫描，获得数据之后再进行截取、计算，导致索引索引失效。同时，还伴随着性能问题。</p><p>示例中只列举了 SUBSTR 函数，像 CONCAT 等类似的函数，也都会出现类似的情况。解决方案可参考第三种场景，可考虑先通过内存计算或其他方式减少数据库来进行内容的处理。</p><p>第四种索引失效情况：<strong>索引列参与了函数处理，会导致全表扫描，索引失效</strong>。</p><h2 id=5-错误的-like-使用>5 错误的 Like 使用</h2><p>示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>like</span><span style=color:#bbb> </span><span style=color:#b44>&#39;%00%&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233122082.png alt=image-20230823233122082></p><p>针对<code>like</code>的使用非常频繁，但使用不当往往会导致不走索引。常见的 like 使用方式有：</p><ul><li>方式一：like &lsquo;%abc&rsquo;；</li><li>方式二：like &lsquo;abc%&rsquo;；</li><li>方式三：like &lsquo;%abc%&rsquo;；</li></ul><p>其中方式一和方式三，由于占位符出现在首部，导致无法走索引。这种情况不做索引的原因很容易理解，索引本身就相当于目录，从左到右逐个排序。而条件的左侧使用了占位符，导致无法按照正常的目录进行匹配，导致索引失效就很正常了。</p><p>第五种索引失效情况：<strong>模糊查询时（like 语句），模糊匹配的占位符位于条件的首部</strong>。</p><h2 id=6-类型隐式转换>6 类型隐式转换</h2><p>示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>1002</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233155275.png alt=image-20230823233155275></p><p><code>id_no</code>字段类型为 varchar，但在 SQL 语句中使用了 int 类型，导致全表扫描。</p><p>出现索引失效的原因是：varchar 和 int 是两个种不同的类型。</p><p>解决方案就是将参数<code>1002</code>添加上单引号或双引号。</p><p>第六种索引失效情况：<strong>参数类型与字段类型不匹配，导致类型发生了隐式转换，索引失效</strong>。</p><p>这种情况还有一个特例，如果字段类型为 int 类型，而查询条件添加了单引号或双引号，则 Mysql 会参数转化为 int 类型，虽然使用了单引号或双引号：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>上述语句是依旧会走索引的。</p><h2 id=7使用-or-操作>7、使用 OR 操作</h2><p>OR 是日常使用最多的操作关键字了，但使用不当，也会导致索引失效。</p><p>示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>or</span><span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;Tom2&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233215122.png alt=image-20230823233215122></p><p>看到上述执行结果是否是很惊奇啊，明明 id 字段是有索引的，由于使用<code>or</code>关键字，索引竟然失效了。</p><p>其实，换一个角度来想，如果单独使用<code>username</code>字段作为条件很显然是全表扫描，既然已经进行了全表扫描了，前面<code>id</code>的条件再走一次索引反而是浪费了。所以，在使用 or 关键字时，切记两个条件都要添加索引，否则会导致索引失效。</p><p>但如果 or 两边同时使用 “>” 和“&lt;”，则索引也会失效：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb>  </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>or</span><span style=color:#bbb> </span>id<span style=color:#bbb>  </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span><span style=color:#666>80</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233252023.png alt=image-20230823233252023></p><p>第七种索引失效情况：<strong>查询条件使用 or 关键字，其中一个字段没有创建索引，则会导致整个查询语句索引失效； or 两边为 “>” 和“&lt;”范围查询时，索引失效</strong>。</p><h2 id=8-两列做比较>8 两列做比较</h2><p>如果两个列数据都有索引，但在查询条件中对两列数据进行了对比操作，则会导致索引失效。</p><p>这里举个不恰当的示例，比如 age 小于 id 这样的两列（真实场景可能是两列同维度的数据比较，这里迁就现有表结构）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>age;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233309172.png alt=image-20230823233309172></p><p>这里虽然 id 有索引，age 也可以创建索引，但当两列做比较时，索引还是会失效的。</p><p>第八种索引失效情况：<strong>两列数据做比较，即便两列都创建了索引，索引也会失效</strong>。</p><h2 id=9-不等于比较>9 不等于比较</h2><p>示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#666>&lt;&gt;</span><span style=color:#bbb> </span><span style=color:#b44>&#39;1002&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233324769.png alt=image-20230823233324769></p><p>当查询条件为字符串时，使用”&lt;>“或”!=“作为条件查询，有可能不走索引，但也不全是。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>create_time<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2022-02-27 09:56:42&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>上述 SQL 中，由于 “2022-02-27 09:56:42” 是存储过程在同一秒生成的，大量数据是这个时间。执行之后会发现，当查询结果集占比比较小时，会走索引，占比比较大时不会走索引。此处与结果集与总体的占比有关。</p><p>需要注意的是：上述语句如果是<code>id</code>进行不等操作，则正常走索引。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span><span style=color:#666>2</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233340551.png alt=image-20230823233340551></p><p>第九种索引失效情况：<strong>查询条件使用不等进行比较时，需要慎重，普通索引会查询结果集占比较大时索引会失效</strong>。</p><h2 id=10-is-not-null>10 is not null</h2><p>示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>is</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233355644.png alt=image-20230823233355644></p><p>第十种索引失效情况：<strong>查询条件使用 is null 时正常走索引，使用 is not null 时，不走索引</strong>。</p><h2 id=11-not-in-和-not-exists>11 not in 和 not exists</h2><p>在日常中使用比较多的范围查询有 in、exists、not in、not exists、between and 等。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span>(<span style=color:#666>2</span>,<span style=color:#666>3</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span>​</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span>(<span style=color:#b44>&#39;1001&#39;</span>,<span style=color:#b44>&#39;1002&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span>​</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span>u1<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>exists</span><span style=color:#bbb> </span>(<span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span>u2<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>u2.id<span style=color:#bbb>  </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>and</span><span style=color:#bbb> </span>u2.id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>u1.id);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span>​</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>between</span><span style=color:#bbb> </span><span style=color:#b44>&#39;1002&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>and</span><span style=color:#bbb> </span><span style=color:#b44>&#39;1003&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>上述四种语句执行时都会正常走索引，具体的 explain 结果就不再展示。主要看不走索引的情况：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>explain select * from t_user where id_no not in(&#39;1002&#39; , &#39;1003&#39;);
</span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233410636.png alt=image-20230823233410636></p><p>当使用<code>not in</code>时，不走索引？把条件列换成主键试试：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span>(<span style=color:#666>2</span>,<span style=color:#666>3</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233425696.png alt=image-20230823233425696></p><p>如果是主键，则正常走索引。</p><p>第十一种索引失效情况：<strong>查询条件使用 not in 时，如果是主键则走索引，如果是普通索引，则索引失效</strong>。</p><p>再来看看<code>not exists</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span>u1<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>exists</span><span style=color:#bbb> </span>(<span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span>u2<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>u2.id<span style=color:#bbb>  </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>and</span><span style=color:#bbb> </span>u2.id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>u1.id);<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233438205.png alt=image-20230823233438205></p><p>当查询条件使用<code>not exists</code>时，不走索引。</p><p>第十二种索引失效情况：<strong>查询条件使用 not exists 时，索引失效</strong>。</p><h2 id=12-order-by-导致索引失效>12 order by 导致索引失效</h2><p>示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233453169.png alt=image-20230823233453169></p><p>其实这种情况的索引失效很容易理解，毕竟需要对全表数据进行排序处理。</p><p>那么，添加删 limit 关键字是否就走索引了呢？</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>limit</span><span style=color:#bbb> </span><span style=color:#666>10</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233507837.png alt=image-20230823233507837></p><p>结果依旧不走索引。在网络上看到有说如果<code>order by</code>条件满足最左匹配则会正常走索引， 在当前 8.0.18 版本中并未出现。所以，在基于<code>order by</code>和<code>limit</code>进行使用时，要特别留意。是否走索引不仅涉及到数据库版本，还要看 Mysql 优化器是如何处理的。</p><p>这里还有一个特例，就是主键使用<code>order by</code>时，可以正常走索引。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>desc</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233521590.png alt=image-20230823233521590></p><p>可以看出针对主键，还是<code>order by</code>可以正常走索引。</p><p>另外，笔者测试如下 SQL 语句：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>age;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span>,<span style=color:#bbb> </span>username<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>age;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>id_no;<span style=color:#bbb>
</span></span></span></code></pre></div><p>上述三条 SQL 语句都是走索引的，也就是说覆盖索引的场景也是可以正常走索引的。</p><p>现在将<code>id</code>和<code>id_no</code>组合起来进行<code>order by</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>id,id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>desc</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>id,id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>desc</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>limit</span><span style=color:#bbb> </span><span style=color:#666>10</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>by</span><span style=color:#bbb> </span>id_no<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>desc</span>,username<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>desc</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233535630.png alt=image-20230823233535630></p><p>上述两个 SQL 语句，都未走索引。</p><p>第十三种索引失效情况：<strong>当查询条件涉及到 order by、limit 等条件时，是否走索引情况比较复杂，而且与 Mysql 版本有关，通常普通索引，如果未使用 limit，则不会走索引。order by 多个索引字段时，可能不会走索引。其他情况，建议在使用时进行 expain 验证。</strong></p><h2 id=13-参数不同导致索引失效>13 参数不同导致索引失效</h2><p>此时，如果你还未执行最开始创建的存储过程，建议你先执行一下存储过程，然后执行如下 SQL：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>create_time<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2023-02-24 09:04:23&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>其中，时间是未来的时间，确保能够查到数据。</p><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233549826.png alt=image-20230823233549826></p><p>可以看到，正常走索引。</p><p>随后，我们将查询条件的参数换个日期：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a2f;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>from</span><span style=color:#bbb> </span>t_user<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>where</span><span style=color:#bbb> </span>create_time<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2022-02-27 09:04:23&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>explain 结果：</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230823233607173.png alt=image-20230823233607173></p><p>此时，进行了全表扫描。这也是最开始提到的奇怪的现象。</p><p>为什么同样的查询语句，只是查询的参数值不同，却会出现一个走索引，一个不走索引的情况呢？</p><p>答案很简单：<strong>上述索引失效是因为 DBMS 发现全表扫描比走索引效率更高，因此就放弃了走索引</strong>。</p><p>也就是说，当 Mysql 发现通过索引扫描的行记录数超过全表的 10%-30% 时，优化器可能会放弃走索引，自动变成全表扫描。某些场景下即便强制 SQL 语句走索引，也同样会失效。</p><p>类似的问题，在进行范围查询（比如 >、&lt;、>=、&lt;=、in 等条件）时往往会出现上述情况，而上面提到的临界值根据场景不同也会有所不同。</p><p>第十四种索引失效情况：<strong>当查询条件为大于等于、in 等范围查询时，根据查询结果占全表数据比例的不同，优化器有可能会放弃索引，进行全表扫描。</strong></p><h2 id=14-其他>14 其他</h2><p>当然，还有其他一些是否走索引的规则，这与索引的类型是 B-tree 索引还是位图索引也有关系，就不再详细展开。</p><p>这里要说的其他，可以总结为第十五种索引失效的情况：<strong>Mysql 优化器的其他优化策略，比如优化器认为在某些情况下，全表扫描比走索引快，则它就会放弃索引。</strong></p><p>针对这种情况，一般不用过多理会，当发现问题时再定点排查即可。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/mysql rel=tag title=Mysql>#Mysql#</a>
<a href=/tags/mysql%e7%b4%a2%e5%bc%95 rel=tag title=Mysql索引>#Mysql索引#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>15个必知的 Mysql 索引失效场景</p><p><span>链接：</span>https://codingroam.github.io/post/15%E4%B8%AA%E5%BF%85%E7%9F%A5%E7%9A%84-mysql-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/</p><p><span>作者：</span>roam</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://codingroam.github.io/post/mongodb-%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/ rel=next title=MongoDB学习总结><i class="fa fa-chevron-left"></i> MongoDB学习总结</a></div><div class="post-nav-prev post-nav-item"><a href=https://codingroam.github.io/post/golang%E5%87%BD%E6%95%B0%E5%80%BC%E4%BC%A0%E9%80%92%E9%97%AE%E9%A2%98/ rel=prev title="Golang 语言规范(一)——函数参数值传递问题">Golang 语言规范(一)——函数参数值传递问题
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=roam><p class=site-author-name itemprop=name>roam</p><p class="site-description motion-element" itemprop=description>以为打得赢我啊你</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>81</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>29</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>60</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/wk123456/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://www.zhihu.com/ target=_blank title=知乎><i class="fa fa-fw fa-globe"></i>
知乎</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://nutzam.com/ title=Nutz target=_blank>Nutz</a></li><li class=links-of-blogroll-item><a href=https://jfinal.com/ title=JFinal target=_blank>JFinal</a></li><li class=links-of-blogroll-item><a href=http://wendal.net/ title=Wendal target=_blank>Wendal</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/learning>Learning
<sup>27</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql
<sup>12</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/java>Java
<sup>11</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6>中间件
<sup>10</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/golang>Golang
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/golang%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0>Golang编程学习
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/linux>Linux
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/redis>Redis
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/problem-solving>Problem solving
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker
<sup>6</sup></a></li></ul></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>想学啊你</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.115.4</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://gitee.com/ style=font-weight:700 target=_blank>Gitee 仓库</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=http://beian.miit.gov.cn target=_blank>粤 ICP 备 18047355 号</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://codingroam.github.io/js/search.js></script>
<script type=text/javascript src=https://codingroam.github.io/js/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".footer").outerHeight(!0),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var e,t,n,s,o=$(".header-inner").height()+10;$("#sidebar").css({"margin-top":o}).show(),t=parseInt($("#sidebar").css("margin-top")),n=parseInt($(".sidebar-inner").css("height")),e=t+n,s=$(".content-wrap").height(),s<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>const locale={placeholder:"欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^"};$(function(){detectIE()>0?$.getScript(document.location.protocol+"//unpkg.com/@waline/client@1.6.0/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,emoji:[],wordLimit:"200",uploadImage:!1,locale,requiredMeta:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>