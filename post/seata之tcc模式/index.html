<!doctype html><html lang=zh-cn dir=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>Seata之TCC模式 - 想学啊你</title><meta name=keywords content="博客"><meta name=author content="roam"><meta property="og:title" content="Seata之TCC模式"><meta property="og:site_name" content="想学啊你"><meta property="og:image" content="https://codingroam.github.io/img/author.jpg"><meta name=title content="Seata之TCC模式 - 想学啊你"><meta name=description content="轻轻的你来了"><link rel="shortcut icon" href=https://codingroam.github.io/img/favicon.ico><link rel=apple-touch-icon href=https://codingroam.github.io/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://codingroam.github.io/img/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=https://codingroam.github.io/css/main.css rel=stylesheet type=text/css><link href=https://codingroam.github.io/css/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-Hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>想学啊你</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>三四楼那么高了</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class=menu-item><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-book"></i><br>分类</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://codingroam.github.io/post/seata%E4%B9%8Btcc%E6%A8%A1%E5%BC%8F/ itemprop=url>Seata之TCC模式</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2023-08-05">2023-08-05</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/seata itemprop=url rel=index><span itemprop=name>Seata</span></a>
&nbsp;</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6 itemprop=url rel=index><span itemprop=name>中间件</span></a>
&nbsp;</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/%E5%88%86%E5%B8%83%E5%BC%8F itemprop=url rel=index><span itemprop=name>分布式</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>8140 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>17分钟</span></span>
<span id=/post/seata%E4%B9%8Btcc%E6%A8%A1%E5%BC%8F/ class="leancloud_visitors post-visitor" data-flag-title=Seata之TCC模式><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><p>Seata之TCC模式</p><p>TCC 是分布式事务中的二阶段提交协议，它的全称为 Try-Confirm-Cancel，即资源预留（Try）、确认操作（Confirm）、取消操作（Cancel），他们的具体含义如下： 对于TCC的解释: <strong>Try阶段：尝试执行,完成所有业务检查（一致性）,预留必须业务资源（准隔离性）</strong> <strong>Confirm阶段：确认执行真正执行业务，不作任何业务检查，只使用Try阶段预留的业务资源，Confirm操作满足幂等性。要求具备幂等设计，Confirm失败·后需要进行重试。</strong> <strong>Cancel阶段：取消执行，释放Try阶段预留的业务资源 Cancel操作满足幂等性Cancel阶段的异常和Confirm阶段异常处理方案基本上一致。</strong> 对TCC的理解概括如下： <strong>基于Confirm 与 Cancel任务执行必然成功的假设下，TCC仍然是一个2PC协议。</strong> <strong>在分布式环境下，它没有提供一个全局的锁的机制去控制资源竞争，仅是约定一个异常时处理回滚操作的流程。</strong> <strong>也因为如此他的性能强于AT模式</strong></p><p>TCC 是一种侵入式的分布式事务解决方案，以上三个操作都需要业务系统自行实现，对业务系统有着非常大的入侵性，设计相对复杂，但优点是 TCC 完全不依赖数据库，能够实现跨数据库、跨应用资源管理，对这些不同数据访问通过侵入式的编码方式实现一个原子操作(要么一起commit，要么一起rollback)，更好地解决了在各种复杂业务场景下的分布式事务问题。</p><p>就以电商系统中下订单为例，为了演示，直接去掉账户服务，以订单服务、库存服务为例介绍。 具体的逻辑如下： 客户端调用下订单接口 扣库存 创建订单 请求完成 根据上面的逻辑可知，订单服务肯定是主业务服务，事务的发起方，库存服务是从业务服务，参与事务的决策。</p><p><strong>Seat的AT模式解决方案伪代码如下：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@GlobalTransactional</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> Result<span style=color:#666>&lt;</span>Void<span style=color:#666>&gt;</span> <span style=color:#00a000>createOrder</span><span style=color:#666>(</span>Long productId<span style=color:#666>,</span>Long num<span style=color:#666>,.....){</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//1、扣库存
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    reduceStorage<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//2、创建订单
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    saveOrder<span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p><strong>@GlobalTransactional这个注解用于发起一个全局事务。</strong> 但是AT模式有局限性，如下： 性能低，锁定资源时间太长 无法解决跨应用的事务 因此对于要求性能的下单接口，可以考虑使用TCC模式进行拆分成两阶段执行，这样整个流程锁定资源的时间将会变短，性能也能提高。 此时的TCC模式的拆分如下： <strong>1、一阶段的Try操作</strong> TCC模式中的Try阶段其实就是预留资源，在这个过程中可以将需要的商品数量的库存冻结，这样就要在库存表中维护一个冻结的库存这个字段。 伪代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Transactional</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>try</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>//冻结库存
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  frozenStorage<span style=color:#666>();</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>//生成订单，状态为待确认
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  saveOrder<span style=color:#666>();</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>注意：@Transactional开启了本地事务，只要出现了异常，本地事务将会回滚，同时执行第二阶段的cancel操作。 <strong>二阶段的confirm操作</strong> confirm操作在一阶段try操作成功之后提交事务，涉及到的操作如下： 释放try操作冻结的库存（冻结库存-购买数量） 生成订单 伪代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Transactional</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>confirm</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//释放掉try操作预留的库存
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    cleanFrozen<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//修改订单，状态为已完成
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    updateOrder<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>注意：这里如果返回false，遵循TCC规范，应该要不断重试，直到confirm完成。 二阶段的cancel操作 cancel操作在一阶段try操作出现异常之后执行，用于回滚资源，涉及到的操作如下： 恢复冻结的库存（冻结库存-购买数量、库存+购买数量） 删除订单</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Transactional</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>cancel</span><span style=color:#666>(){</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//释放掉try操作预留的库存
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    rollbackFrozen<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//修改订单，状态为已完成
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    delOrder<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>注意：这里如果返回false，遵循TCC规范，应该要不断重试，直到cancel完成。</p><p>假设现有一个业务需要同时使用服务 A 和服务 B 完成一个事务操作，我们在服务 A 定义该服务的一个 TCC 接口：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>interface</span> <span style=color:#00f>TccActionOne</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#a2f>@TwoPhaseBusinessAction</span><span style=color:#666>(</span>name <span style=color:#666>=</span> <span style=color:#b44>&#34;DubboTccActionOne&#34;</span><span style=color:#666>,</span> commitMethod <span style=color:#666>=</span> <span style=color:#b44>&#34;commit&#34;</span><span style=color:#666>,</span> rollbackMethod <span style=color:#666>=</span> <span style=color:#b44>&#34;rollback&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>prepare</span><span style=color:#666>(</span>BusinessActionContext actionContext<span style=color:#666>,</span> <span style=color:#a2f>@BusinessActionContextParameter</span><span style=color:#666>(</span>paramName <span style=color:#666>=</span> <span style=color:#b44>&#34;a&#34;</span><span style=color:#666>)</span> String a<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>commit</span><span style=color:#666>(</span>BusinessActionContext actionContext<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>rollback</span><span style=color:#666>(</span>BusinessActionContext actionContext<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>同样，在服务 B 定义该服务的一个 TCC 接口：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>interface</span> <span style=color:#00f>TccActionTwo</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#a2f>@TwoPhaseBusinessAction</span><span style=color:#666>(</span>name <span style=color:#666>=</span> <span style=color:#b44>&#34;DubboTccActionTwo&#34;</span><span style=color:#666>,</span> commitMethod <span style=color:#666>=</span> <span style=color:#b44>&#34;commit&#34;</span><span style=color:#666>,</span> rollbackMethod <span style=color:#666>=</span> <span style=color:#b44>&#34;rollback&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>prepare</span><span style=color:#666>(</span>BusinessActionContext actionContext<span style=color:#666>,</span> <span style=color:#a2f>@BusinessActionContextParameter</span><span style=color:#666>(</span>paramName <span style=color:#666>=</span> <span style=color:#b44>&#34;b&#34;</span><span style=color:#666>)</span> String b<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>commit</span><span style=color:#666>(</span>BusinessActionContext actionContext<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>rollback</span><span style=color:#666>(</span>BusinessActionContext actionContext<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>业务系统分别调用两个服务，要求两个服务可以通过是成功或者同时失败</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#666>*/</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@GlobalTransactional</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> String <span style=color:#00a000>doTransactionCommit</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//第一个TCC 事务参与者
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        <span style=color:#0b0;font-weight:700>boolean</span> result <span style=color:#666>=</span> tccActionOne<span style=color:#666>.</span><span style=color:#b44>prepare</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#666>1</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>result<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span><span style=color:#b44>&#34;TccActionOne failed.&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        List list <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ArrayList<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        list<span style=color:#666>.</span><span style=color:#b44>add</span><span style=color:#666>(</span><span style=color:#b44>&#34;c1&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        list<span style=color:#666>.</span><span style=color:#b44>add</span><span style=color:#666>(</span><span style=color:#b44>&#34;c2&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> tccActionTwo<span style=color:#666>.</span><span style=color:#b44>prepare</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#b44>&#34;two&#34;</span><span style=color:#666>,</span> list<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>result<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span><span style=color:#b44>&#34;TccActionTwo failed.&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> RootContext<span style=color:#666>.</span><span style=color:#b44>getXID</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>以上就是使用 Seata TCC 模式实现一个全局事务的例子，可以看出，TCC 模式同样使用 @GlobalTransactiona 注解开启全局事务，而服务 A 和服务 B 的 TCC 接口为事务参与者，Seata 会把一个 TCC 接口当成一个 Resource，也叫 TCC Resource。 Seata 启动时会对 TCC 接口进行扫描并解析，如果 TCC 接口是一个发布方，则在 Seata 启动时会向 TC 注册 TCC Resource，每个 TCC Resource 都有一个资源 ID；如果 TCC 接口时一个调用方，Seata 代理调用方，与 AT 模式一样，代理会拦截 TCC 接口的调用，即每次调用 Try 方法，会向 TC 注册一个分支事务，接着才执行原来的 RPC 调用。 当全局事务决议提交/回滚时，TC 会通过分支注册的的资源 ID 回调到对应参与者服务中执行 TCC Resource 的 Confirm/rollback方法。<strong>做到要么同时成功，要么同时失败。</strong></p><h2 id=globaltransactionscanner>GlobalTransactionScanner</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>GlobalTransactionScanner</span> <span style=color:#a2f;font-weight:700>extends</span> AbstractAutoProxyCreator
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>implements</span> ConfigurationChangeListener<span style=color:#666>,</span> InitializingBean<span style=color:#666>,</span> ApplicationContextAware<span style=color:#666>,</span> DisposableBean <span style=color:#666>{</span>
</span></span></code></pre></div><p>继承InitializingBean，加载完毕后执行afterPropertiesSet</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>afterPropertiesSet</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>disableGlobalTransaction<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>LOGGER<span style=color:#666>.</span><span style=color:#b44>isInfoEnabled</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Global transaction is disabled.&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            ConfigurationCache<span style=color:#666>.</span><span style=color:#b44>addConfigListener</span><span style=color:#666>(</span>ConfigurationKeys<span style=color:#666>.</span><span style=color:#b44>DISABLE_GLOBAL_TRANSACTION</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>(</span>ConfigurationChangeListener<span style=color:#666>)</span><span style=color:#a2f;font-weight:700>this</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>initialized<span style=color:#666>.</span><span style=color:#b44>compareAndSet</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>false</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            initClient<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>初始化Tm和RM客户端</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>initClient</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//init TM
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        TMClient<span style=color:#666>.</span><span style=color:#b44>init</span><span style=color:#666>(</span>applicationId<span style=color:#666>,</span> txServiceGroup<span style=color:#666>,</span> accessKey<span style=color:#666>,</span> secretKey<span style=color:#666>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//init RM
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        RMClient<span style=color:#666>.</span><span style=color:#b44>init</span><span style=color:#666>(</span>applicationId<span style=color:#666>,</span> txServiceGroup<span style=color:#666>);</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        registerSpringShutdownHook<span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>初始化netty属性</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>init</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        timerExecutor<span style=color:#666>.</span><span style=color:#b44>scheduleAtFixedRate</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> Runnable<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                clientChannelManager<span style=color:#666>.</span><span style=color:#b44>reconnect</span><span style=color:#666>(</span>getTransactionServiceGroup<span style=color:#666>());</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>},</span> SCHEDULE_DELAY_MILLS<span style=color:#666>,</span> SCHEDULE_INTERVAL_MILLS<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#b44>MILLISECONDS</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>NettyClientConfig<span style=color:#666>.</span><span style=color:#b44>isEnableClientBatchSendRequest</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            mergeSendExecutorService <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ThreadPoolExecutor<span style=color:#666>(</span>MAX_MERGE_SEND_THREAD<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                MAX_MERGE_SEND_THREAD<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                KEEP_ALIVE_TIME<span style=color:#666>,</span> TimeUnit<span style=color:#666>.</span><span style=color:#b44>MILLISECONDS</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>new</span> LinkedBlockingQueue<span style=color:#666>&lt;&gt;(),</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>new</span> NamedThreadFactory<span style=color:#666>(</span>getThreadPrefix<span style=color:#666>(),</span> MAX_MERGE_SEND_THREAD<span style=color:#666>));</span>
</span></span><span style=display:flex><span>            mergeSendExecutorService<span style=color:#666>.</span><span style=color:#b44>submit</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> MergedSendRunnable<span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>super</span><span style=color:#666>.</span><span style=color:#b44>init</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        clientBootstrap<span style=color:#666>.</span><span style=color:#b44>start</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>10秒一次的检查重连seata-server的线程。 一个发送消息的线程，不断从basketMap中取数据</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>protected</span> <span style=color:#a2f;font-weight:700>final</span> ConcurrentHashMap<span style=color:#666>&lt;</span>String<span style=color:#080;font-style:italic>/*serverAddress*/</span><span style=color:#666>,</span> BlockingQueue<span style=color:#666>&lt;</span>RpcMessage<span style=color:#666>&gt;&gt;</span> basketMap <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ConcurrentHashMap<span style=color:#666>&lt;&gt;();</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>MergedSendRunnable</span> <span style=color:#a2f;font-weight:700>implements</span> Runnable <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>run</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(</span><span style=color:#a2f;font-weight:700>true</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>mergeLock<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        mergeLock<span style=color:#666>.</span><span style=color:#b44>wait</span><span style=color:#666>(</span>MAX_MERGE_SEND_MILLS<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>InterruptedException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                isSending <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                basketMap<span style=color:#666>.</span><span style=color:#b44>forEach</span><span style=color:#666>((</span>address<span style=color:#666>,</span> basket<span style=color:#666>)</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>basket<span style=color:#666>.</span><span style=color:#b44>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    MergedWarpMessage mergeMessage <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> MergedWarpMessage<span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(!</span>basket<span style=color:#666>.</span><span style=color:#b44>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        RpcMessage msg <span style=color:#666>=</span> basket<span style=color:#666>.</span><span style=color:#b44>poll</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                        mergeMessage<span style=color:#666>.</span><span style=color:#b44>msgs</span><span style=color:#666>.</span><span style=color:#b44>add</span><span style=color:#666>((</span>AbstractMessage<span style=color:#666>)</span> msg<span style=color:#666>.</span><span style=color:#b44>getBody</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                        mergeMessage<span style=color:#666>.</span><span style=color:#b44>msgIds</span><span style=color:#666>.</span><span style=color:#b44>add</span><span style=color:#666>(</span>msg<span style=color:#666>.</span><span style=color:#b44>getId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>mergeMessage<span style=color:#666>.</span><span style=color:#b44>msgIds</span><span style=color:#666>.</span><span style=color:#b44>size</span><span style=color:#666>()</span> <span style=color:#666>&gt;</span> <span style=color:#666>1</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        printMergeMessageLog<span style=color:#666>(</span>mergeMessage<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    Channel sendChannel <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#080;font-style:italic>// send batch message is sync request, but there is no need to get the return value.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        <span style=color:#080;font-style:italic>// Since the messageFuture has been created before the message is placed in basketMap,
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        <span style=color:#080;font-style:italic>// the return value will be obtained in ClientOnResponseProcessor.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        sendChannel <span style=color:#666>=</span> clientChannelManager<span style=color:#666>.</span><span style=color:#b44>acquireChannel</span><span style=color:#666>(</span>address<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                        AbstractNettyRemotingClient<span style=color:#666>.</span><span style=color:#b44>this</span><span style=color:#666>.</span><span style=color:#b44>sendAsyncRequest</span><span style=color:#666>(</span>sendChannel<span style=color:#666>,</span> mergeMessage<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>FrameworkException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>e<span style=color:#666>.</span><span style=color:#b44>getErrcode</span><span style=color:#666>()</span> <span style=color:#666>==</span> FrameworkErrorCode<span style=color:#666>.</span><span style=color:#b44>ChannelIsNotWritable</span> <span style=color:#666>&amp;&amp;</span> sendChannel <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                            destroyChannel<span style=color:#666>(</span>address<span style=color:#666>,</span> sendChannel<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#080;font-style:italic>// fast fail
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>Integer msgId <span style=color:#666>:</span> mergeMessage<span style=color:#666>.</span><span style=color:#b44>msgIds</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                            MessageFuture messageFuture <span style=color:#666>=</span> futures<span style=color:#666>.</span><span style=color:#b44>remove</span><span style=color:#666>(</span>msgId<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>messageFuture <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                messageFuture<span style=color:#666>.</span><span style=color:#b44>setResultMessage</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                        LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;client merge call failed: {}&#34;</span><span style=color:#666>,</span> e<span style=color:#666>.</span><span style=color:#b44>getMessage</span><span style=color:#666>(),</span> e<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>});</span>
</span></span><span style=display:flex><span>                isSending <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>当有消息需要发送，放入到basketMap，此线程会发送消息，起到一个发送消息的缓冲作用</p><h2 id=资源注册>资源注册</h2><h3 id=rm注册>RM注册</h3><p>每个服务，既可以是事务发起者，也可以是事务参与者。因此，每台服务既是TM同时也是RM GlobalTransactionScanner还继承了AbstractAutoProxyCreator 在bean加载完成时会执行wrapIfNecessary</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Override
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>protected</span> Object <span style=color:#00a000>wrapIfNecessary</span><span style=color:#666>(</span>Object bean<span style=color:#666>,</span> String beanName<span style=color:#666>,</span> Object cacheKey<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>PROXYED_SET<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>PROXYED_SET<span style=color:#666>.</span><span style=color:#b44>contains</span><span style=color:#666>(</span>beanName<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> bean<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                interceptor <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//check TCC proxy
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>TCCBeanParserUtils<span style=color:#666>.</span><span style=color:#b44>isTccAutoProxy</span><span style=color:#666>(</span>bean<span style=color:#666>,</span> beanName<span style=color:#666>,</span> applicationContext<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>//TCC interceptor, proxy bean of sofa:reference/dubbo:reference, and LocalTCC
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    interceptor <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> TccActionInterceptor<span style=color:#666>(</span>TCCBeanParserUtils<span style=color:#666>.</span><span style=color:#b44>getRemotingDesc</span><span style=color:#666>(</span>beanName<span style=color:#666>));</span>
</span></span><span style=display:flex><span>                    ConfigurationCache<span style=color:#666>.</span><span style=color:#b44>addConfigListener</span><span style=color:#666>(</span>ConfigurationKeys<span style=color:#666>.</span><span style=color:#b44>DISABLE_GLOBAL_TRANSACTION</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#666>(</span>ConfigurationChangeListener<span style=color:#666>)</span>interceptor<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    Class<span style=color:#666>&lt;?&gt;</span> serviceInterface <span style=color:#666>=</span> SpringProxyUtils<span style=color:#666>.</span><span style=color:#b44>findTargetClass</span><span style=color:#666>(</span>bean<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    Class<span style=color:#666>&lt;?&gt;[]</span> interfacesIfJdk <span style=color:#666>=</span> SpringProxyUtils<span style=color:#666>.</span><span style=color:#b44>findInterfaces</span><span style=color:#666>(</span>bean<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>existsAnnotation<span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> Class<span style=color:#666>[]{</span>
</span></span><span style=display:flex><span>   serviceInterface<span style=color:#666>})</span>
</span></span><span style=display:flex><span>                        <span style=color:#666>&amp;&amp;</span> <span style=color:#666>!</span>existsAnnotation<span style=color:#666>(</span>interfacesIfJdk<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>return</span> bean<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>globalTransactionalInterceptor <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        globalTransactionalInterceptor <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> GlobalTransactionalInterceptor<span style=color:#666>(</span>failureHandlerHook<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                        ConfigurationCache<span style=color:#666>.</span><span style=color:#b44>addConfigListener</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>                            ConfigurationKeys<span style=color:#666>.</span><span style=color:#b44>DISABLE_GLOBAL_TRANSACTION</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>(</span>ConfigurationChangeListener<span style=color:#666>)</span>globalTransactionalInterceptor<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    interceptor <span style=color:#666>=</span> globalTransactionalInterceptor<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Bean[{}] with name [{}] would use interceptor [{}]&#34;</span><span style=color:#666>,</span> bean<span style=color:#666>.</span><span style=color:#b44>getClass</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>(),</span> beanName<span style=color:#666>,</span> interceptor<span style=color:#666>.</span><span style=color:#b44>getClass</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>AopUtils<span style=color:#666>.</span><span style=color:#b44>isAopProxy</span><span style=color:#666>(</span>bean<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    bean <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>super</span><span style=color:#666>.</span><span style=color:#b44>wrapIfNecessary</span><span style=color:#666>(</span>bean<span style=color:#666>,</span> beanName<span style=color:#666>,</span> cacheKey<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    AdvisedSupport advised <span style=color:#666>=</span> SpringProxyUtils<span style=color:#666>.</span><span style=color:#b44>getAdvisedSupport</span><span style=color:#666>(</span>bean<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    Advisor<span style=color:#666>[]</span> advisor <span style=color:#666>=</span> buildAdvisors<span style=color:#666>(</span>beanName<span style=color:#666>,</span> getAdvicesAndAdvisorsForBean<span style=color:#666>(</span><span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>));</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>Advisor avr <span style=color:#666>:</span> advisor<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        advised<span style=color:#666>.</span><span style=color:#b44>addAdvisor</span><span style=color:#666>(</span><span style=color:#666>0</span><span style=color:#666>,</span> avr<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                PROXYED_SET<span style=color:#666>.</span><span style=color:#b44>add</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>return</span> bean<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Exception exx<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> RuntimeException<span style=color:#666>(</span>exx<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>isTccAutoProxy</span><span style=color:#666>(</span>Object bean<span style=color:#666>,</span> String beanName<span style=color:#666>,</span> ApplicationContext applicationContext<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#0b0;font-weight:700>boolean</span> isRemotingBean <span style=color:#666>=</span> parserRemotingServiceInfo<span style=color:#666>(</span>bean<span style=color:#666>,</span> beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//get RemotingBean description
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        RemotingDesc remotingDesc <span style=color:#666>=</span> DefaultRemotingParser<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>().</span><span style=color:#b44>getRemotingBeanDesc</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//is remoting bean
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>isRemotingBean<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>remotingDesc <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> remotingDesc<span style=color:#666>.</span><span style=color:#b44>getProtocol</span><span style=color:#666>()</span> <span style=color:#666>==</span> Protocols<span style=color:#666>.</span><span style=color:#b44>IN_JVM</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//LocalTCC
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>return</span> isTccProxyTargetBean<span style=color:#666>(</span>remotingDesc<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>// sofa:reference / dubbo:reference, factory bean
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>remotingDesc <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//check FactoryBean
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>isRemotingFactoryBean<span style=color:#666>(</span>bean<span style=color:#666>,</span> beanName<span style=color:#666>,</span> applicationContext<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    remotingDesc <span style=color:#666>=</span> DefaultRemotingParser<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>().</span><span style=color:#b44>getRemotingBeanDesc</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> isTccProxyTargetBean<span style=color:#666>(</span>remotingDesc<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>return</span> isTccProxyTargetBean<span style=color:#666>(</span>remotingDesc<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>如果方法带有TwoPhaseBusinessAction注解，那么注册资源到seata-server</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> RemotingDesc <span style=color:#00a000>parserRemotingServiceInfo</span><span style=color:#666>(</span>Object bean<span style=color:#666>,</span> String beanName<span style=color:#666>,</span> RemotingParser remotingParser<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        RemotingDesc remotingBeanDesc <span style=color:#666>=</span> remotingParser<span style=color:#666>.</span><span style=color:#b44>getServiceDesc</span><span style=color:#666>(</span>bean<span style=color:#666>,</span> beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>remotingBeanDesc <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        remotingServiceMap<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>beanName<span style=color:#666>,</span> remotingBeanDesc<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Class<span style=color:#666>&lt;?&gt;</span> interfaceClass <span style=color:#666>=</span> remotingBeanDesc<span style=color:#666>.</span><span style=color:#b44>getInterfaceClass</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        Method<span style=color:#666>[]</span> methods <span style=color:#666>=</span> interfaceClass<span style=color:#666>.</span><span style=color:#b44>getMethods</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>remotingParser<span style=color:#666>.</span><span style=color:#b44>isService</span><span style=color:#666>(</span>bean<span style=color:#666>,</span> beanName<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//service bean, registry resource
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                Object targetBean <span style=color:#666>=</span> remotingBeanDesc<span style=color:#666>.</span><span style=color:#b44>getTargetBean</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>Method m <span style=color:#666>:</span> methods<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    TwoPhaseBusinessAction twoPhaseBusinessAction <span style=color:#666>=</span> m<span style=color:#666>.</span><span style=color:#b44>getAnnotation</span><span style=color:#666>(</span>TwoPhaseBusinessAction<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>twoPhaseBusinessAction <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        TCCResource tccResource <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> TCCResource<span style=color:#666>();</span>
</span></span><span style=display:flex><span>                        tccResource<span style=color:#666>.</span><span style=color:#b44>setActionName</span><span style=color:#666>(</span>twoPhaseBusinessAction<span style=color:#666>.</span><span style=color:#b44>name</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                        tccResource<span style=color:#666>.</span><span style=color:#b44>setTargetBean</span><span style=color:#666>(</span>targetBean<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                        tccResource<span style=color:#666>.</span><span style=color:#b44>setPrepareMethod</span><span style=color:#666>(</span>m<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                        tccResource<span style=color:#666>.</span><span style=color:#b44>setCommitMethodName</span><span style=color:#666>(</span>twoPhaseBusinessAction<span style=color:#666>.</span><span style=color:#b44>commitMethod</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                        tccResource<span style=color:#666>.</span><span style=color:#b44>setCommitMethod</span><span style=color:#666>(</span>ReflectionUtil
</span></span><span style=display:flex><span>                            <span style=color:#666>.</span><span style=color:#b44>getMethod</span><span style=color:#666>(</span>interfaceClass<span style=color:#666>,</span> twoPhaseBusinessAction<span style=color:#666>.</span><span style=color:#b44>commitMethod</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f;font-weight:700>new</span> Class<span style=color:#666>[]</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   BusinessActionContext<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>}));</span>
</span></span><span style=display:flex><span>                        tccResource<span style=color:#666>.</span><span style=color:#b44>setRollbackMethodName</span><span style=color:#666>(</span>twoPhaseBusinessAction<span style=color:#666>.</span><span style=color:#b44>rollbackMethod</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                        tccResource<span style=color:#666>.</span><span style=color:#b44>setRollbackMethod</span><span style=color:#666>(</span>ReflectionUtil
</span></span><span style=display:flex><span>                            <span style=color:#666>.</span><span style=color:#b44>getMethod</span><span style=color:#666>(</span>interfaceClass<span style=color:#666>,</span> twoPhaseBusinessAction<span style=color:#666>.</span><span style=color:#b44>rollbackMethod</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f;font-weight:700>new</span> Class<span style=color:#666>[]</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   BusinessActionContext<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>}));</span>
</span></span><span style=display:flex><span>                        <span style=color:#080;font-style:italic>//registry tcc resource
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        DefaultResourceManager<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>().</span><span style=color:#b44>registerResource</span><span style=color:#666>(</span>tccResource<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable t<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> FrameworkException<span style=color:#666>(</span>t<span style=color:#666>,</span> <span style=color:#b44>&#34;parser remoting service error&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>remotingParser<span style=color:#666>.</span><span style=color:#b44>isReference</span><span style=color:#666>(</span>bean<span style=color:#666>,</span> beanName<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//reference bean, TCC proxy
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            remotingBeanDesc<span style=color:#666>.</span><span style=color:#b44>setReference</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> remotingBeanDesc<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>组装发送的信息,发送到seata-server <img src=https://img-blog.csdnimg.cn/e1474467f0c946599514dd0d1260358a.png alt=img></p><p>//TCC interceptor, proxy bean of sofa:reference/dubbo:reference, and LocalTCC 由于是提供者RM并没有进行代理 再看服务端注册RM的逻辑 io.seata.core.rpc.netty.ChannelManager#registerRMChannel</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>registerRMChannel</span><span style=color:#666>(</span>RegisterRMRequest resourceManagerRequest<span style=color:#666>,</span> Channel channel<span style=color:#666>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>throws</span> IncompatibleVersionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        Version<span style=color:#666>.</span><span style=color:#b44>checkVersion</span><span style=color:#666>(</span>resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getVersion</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        Set<span style=color:#666>&lt;</span>String<span style=color:#666>&gt;</span> dbkeySet <span style=color:#666>=</span> dbKeytoSet<span style=color:#666>(</span>resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getResourceIds</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        RpcContext rpcContext<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>IDENTIFIED_CHANNELS<span style=color:#666>.</span><span style=color:#b44>containsKey</span><span style=color:#666>(</span>channel<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            rpcContext <span style=color:#666>=</span> buildChannelHolder<span style=color:#666>(</span>NettyPoolKey<span style=color:#666>.</span><span style=color:#b44>TransactionRole</span><span style=color:#666>.</span><span style=color:#b44>RMROLE</span><span style=color:#666>,</span> resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getVersion</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>                resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getApplicationId</span><span style=color:#666>(),</span> resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getTransactionServiceGroup</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>                resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getResourceIds</span><span style=color:#666>(),</span> channel<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            rpcContext<span style=color:#666>.</span><span style=color:#b44>holdInIdentifiedChannels</span><span style=color:#666>(</span>IDENTIFIED_CHANNELS<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            rpcContext <span style=color:#666>=</span> IDENTIFIED_CHANNELS<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>channel<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            rpcContext<span style=color:#666>.</span><span style=color:#b44>addResources</span><span style=color:#666>(</span>dbkeySet<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>dbkeySet <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>||</span> dbkeySet<span style=color:#666>.</span><span style=color:#b44>isEmpty</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span> <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>String resourceId <span style=color:#666>:</span> dbkeySet<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            String clientIp<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            ConcurrentMap<span style=color:#666>&lt;</span>Integer<span style=color:#666>,</span> RpcContext<span style=color:#666>&gt;</span> portMap <span style=color:#666>=</span> CollectionUtils<span style=color:#666>.</span><span style=color:#b44>computeIfAbsent</span><span style=color:#666>(</span>RM_CHANNELS<span style=color:#666>,</span> resourceId<span style=color:#666>,</span> key <span style=color:#666>-&gt;</span> <span style=color:#a2f;font-weight:700>new</span> ConcurrentHashMap<span style=color:#666>&lt;&gt;())</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>.</span><span style=color:#b44>computeIfAbsent</span><span style=color:#666>(</span>resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getApplicationId</span><span style=color:#666>(),</span> key <span style=color:#666>-&gt;</span> <span style=color:#a2f;font-weight:700>new</span> ConcurrentHashMap<span style=color:#666>&lt;&gt;())</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>.</span><span style=color:#b44>computeIfAbsent</span><span style=color:#666>(</span>clientIp <span style=color:#666>=</span> ChannelUtil<span style=color:#666>.</span><span style=color:#b44>getClientIpFromChannel</span><span style=color:#666>(</span>channel<span style=color:#666>),</span> key <span style=color:#666>-&gt;</span> <span style=color:#a2f;font-weight:700>new</span> ConcurrentHashMap<span style=color:#666>&lt;&gt;());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            rpcContext<span style=color:#666>.</span><span style=color:#b44>holdInResourceManagerChannels</span><span style=color:#666>(</span>resourceId<span style=color:#666>,</span> portMap<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            updateChannelsResource<span style=color:#666>(</span>resourceId<span style=color:#666>,</span> clientIp<span style=color:#666>,</span> resourceManagerRequest<span style=color:#666>.</span><span style=color:#b44>getApplicationId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>存储rm信息到_RM_CHANNELS_，记录连接信息。</p><h3 id=tm注册>TM注册</h3><p>客户端注册TM信息</p><h4 id=做必要的代理>做必要的代理</h4><p>在io.seata.spring.annotation.GlobalTransactionScanner#wrapIfNecessary中 如果是 reference bean并且带有TwoPhaseBusinessAction注解，则需要进行代理，进一步增强操作 使用TccActionInterceptor做代理（实际上就是对dubbo本来对服务引用的代理基础上又做了一次代理</p><p>对于带有GlobalTransactional注解的事务发起类做代理</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>private</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>existsAnnotation</span><span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;[]</span> classes<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>CollectionUtils<span style=color:#666>.</span><span style=color:#b44>isNotEmpty</span><span style=color:#666>(</span>classes<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>Class<span style=color:#666>&lt;?&gt;</span> clazz <span style=color:#666>:</span> classes<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>clazz <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>continue</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                GlobalTransactional trxAnno <span style=color:#666>=</span> clazz<span style=color:#666>.</span><span style=color:#b44>getAnnotation</span><span style=color:#666>(</span>GlobalTransactional<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>trxAnno <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                Method<span style=color:#666>[]</span> methods <span style=color:#666>=</span> clazz<span style=color:#666>.</span><span style=color:#b44>getMethods</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>Method method <span style=color:#666>:</span> methods<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    trxAnno <span style=color:#666>=</span> method<span style=color:#666>.</span><span style=color:#b44>getAnnotation</span><span style=color:#666>(</span>GlobalTransactional<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>trxAnno <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    GlobalLock lockAnno <span style=color:#666>=</span> method<span style=color:#666>.</span><span style=color:#b44>getAnnotation</span><span style=color:#666>(</span>GlobalLock<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>lockAnno <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>使用GlobalTransactionalInterceptor进行代理操作</p><h2 id=进入全局事务拦截器>进入全局事务拦截器</h2><p>经过GlobalTransactionalInterceptor</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Object <span style=color:#00a000>invoke</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>final</span> MethodInvocation methodInvocation<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> Throwable <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        Class<span style=color:#666>&lt;?&gt;</span> targetClass <span style=color:#666>=</span>
</span></span><span style=display:flex><span>            methodInvocation<span style=color:#666>.</span><span style=color:#b44>getThis</span><span style=color:#666>()</span> <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>?</span> AopUtils<span style=color:#666>.</span><span style=color:#b44>getTargetClass</span><span style=color:#666>(</span>methodInvocation<span style=color:#666>.</span><span style=color:#b44>getThis</span><span style=color:#666>())</span> <span style=color:#666>:</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        Method specificMethod <span style=color:#666>=</span> ClassUtils<span style=color:#666>.</span><span style=color:#b44>getMostSpecificMethod</span><span style=color:#666>(</span>methodInvocation<span style=color:#666>.</span><span style=color:#b44>getMethod</span><span style=color:#666>(),</span> targetClass<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>specificMethod <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#666>!</span>specificMethod<span style=color:#666>.</span><span style=color:#b44>getDeclaringClass</span><span style=color:#666>().</span><span style=color:#b44>equals</span><span style=color:#666>(</span>Object<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>final</span> Method method <span style=color:#666>=</span> BridgeMethodResolver<span style=color:#666>.</span><span style=color:#b44>findBridgedMethod</span><span style=color:#666>(</span>specificMethod<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>final</span> GlobalTransactional globalTransactionalAnnotation <span style=color:#666>=</span>
</span></span><span style=display:flex><span>                getAnnotation<span style=color:#666>(</span>method<span style=color:#666>,</span> targetClass<span style=color:#666>,</span> GlobalTransactional<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>final</span> GlobalLock globalLockAnnotation <span style=color:#666>=</span> getAnnotation<span style=color:#666>(</span>method<span style=color:#666>,</span> targetClass<span style=color:#666>,</span> GlobalLock<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#0b0;font-weight:700>boolean</span> localDisable <span style=color:#666>=</span> disable <span style=color:#666>||</span> <span style=color:#666>(</span>degradeCheck <span style=color:#666>&amp;&amp;</span> degradeNum <span style=color:#666>&gt;=</span> degradeCheckAllowTimes<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>localDisable<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>globalTransactionalAnnotation <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> handleGlobalTransaction<span style=color:#666>(</span>methodInvocation<span style=color:#666>,</span> globalTransactionalAnnotation<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>globalLockAnnotation <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> handleGlobalLock<span style=color:#666>(</span>methodInvocation<span style=color:#666>,</span> globalLockAnnotation<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> methodInvocation<span style=color:#666>.</span><span style=color:#b44>proceed</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>如果注解GlobalTransactional不为空，处理全局事务 进入事务执行方法 io.seata.tm.api.TransactionalTemplate#execute</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> Object <span style=color:#00a000>execute</span><span style=color:#666>(</span>TransactionalExecutor business<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> Throwable <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>// 1. Get transactionInfo
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        TransactionInfo txInfo <span style=color:#666>=</span> business<span style=color:#666>.</span><span style=color:#b44>getTransactionInfo</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>txInfo <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> ShouldNeverHappenException<span style=color:#666>(</span><span style=color:#b44>&#34;transactionInfo does not exist&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>// 1.1 Get current transaction, if not null, the tx role is &#39;GlobalTransactionRole.Participant&#39;.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        GlobalTransaction tx <span style=color:#666>=</span> GlobalTransactionContext<span style=color:#666>.</span><span style=color:#b44>getCurrent</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>// 1.2 Handle the transaction propagation.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        Propagation propagation <span style=color:#666>=</span> txInfo<span style=color:#666>.</span><span style=color:#b44>getPropagation</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        SuspendedResourcesHolder suspendedResourcesHolder <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>switch</span> <span style=color:#666>(</span>propagation<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>case</span> NOT_SUPPORTED<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// If transaction is existing, suspend it.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>existingTransaction<span style=color:#666>(</span>tx<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        suspendedResourcesHolder <span style=color:#666>=</span> tx<span style=color:#666>.</span><span style=color:#b44>suspend</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// Execute without transaction and return.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>return</span> business<span style=color:#666>.</span><span style=color:#b44>execute</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>case</span> REQUIRES_NEW<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// If transaction is existing, suspend it, and then begin new transaction.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>existingTransaction<span style=color:#666>(</span>tx<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        suspendedResourcesHolder <span style=color:#666>=</span> tx<span style=color:#666>.</span><span style=color:#b44>suspend</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                        tx <span style=color:#666>=</span> GlobalTransactionContext<span style=color:#666>.</span><span style=color:#b44>createNew</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// Continue and execute with new transaction
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>case</span> SUPPORTS<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// If transaction is not existing, execute without transaction.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>notExistingTransaction<span style=color:#666>(</span>tx<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>return</span> business<span style=color:#666>.</span><span style=color:#b44>execute</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// Continue and execute with new transaction
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>case</span> REQUIRED<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// If current transaction is existing, execute with current transaction,
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#080;font-style:italic>// else continue and execute with new transaction.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>case</span> NEVER<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// If transaction is existing, throw exception.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>existingTransaction<span style=color:#666>(</span>tx<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span>
</span></span><span style=display:flex><span>                            String<span style=color:#666>.</span><span style=color:#b44>format</span><span style=color:#666>(</span><span style=color:#b44>&#34;Existing transaction found for transaction marked with propagation &#39;never&#39;, xid = %s&#34;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#666>,</span> tx<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>()));</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#080;font-style:italic>// Execute without transaction and return.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        <span style=color:#a2f;font-weight:700>return</span> business<span style=color:#666>.</span><span style=color:#b44>execute</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>case</span> MANDATORY<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// If transaction is not existing, throw exception.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>notExistingTransaction<span style=color:#666>(</span>tx<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span><span style=color:#b44>&#34;No existing transaction found for transaction marked with propagation &#39;mandatory&#39;&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// Continue and execute with current transaction.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>default</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span><span style=color:#b44>&#34;Not Supported Propagation:&#34;</span> <span style=color:#666>+</span> propagation<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>// 1.3 If null, create new transaction with role &#39;GlobalTransactionRole.Launcher&#39;.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>tx <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                tx <span style=color:#666>=</span> GlobalTransactionContext<span style=color:#666>.</span><span style=color:#b44>createNew</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>// set current tx config to holder
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            GlobalLockConfig previousConfig <span style=color:#666>=</span> replaceGlobalLockConfig<span style=color:#666>(</span>txInfo<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>// 2. If the tx role is &#39;GlobalTransactionRole.Launcher&#39;, send the request of beginTransaction to TC,
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#080;font-style:italic>//    else do nothing. Of course, the hooks will still be triggered.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                beginTransaction<span style=color:#666>(</span>txInfo<span style=color:#666>,</span> tx<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                Object rs<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// Do Your Business
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    rs <span style=color:#666>=</span> business<span style=color:#666>.</span><span style=color:#b44>execute</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>// 3. The needed business exception to rollback.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    completeTransactionAfterThrowing<span style=color:#666>(</span>txInfo<span style=color:#666>,</span> tx<span style=color:#666>,</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>throw</span> ex<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>// 4. everything is fine, commit.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                commitTransaction<span style=color:#666>(</span>tx<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>return</span> rs<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//5. clear
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                resumeGlobalLockConfig<span style=color:#666>(</span>previousConfig<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                triggerAfterCompletion<span style=color:#666>();</span>
</span></span><span style=display:flex><span>                cleanUp<span style=color:#666>();</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>// If the transaction is suspended, resume it.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>suspendedResourcesHolder <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                tx<span style=color:#666>.</span><span style=color:#b44>resume</span><span style=color:#666>(</span>suspendedResourcesHolder<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>获取当前事务信息，根据事务传播属性做进一步判断。</p><h2 id=开启全局事务>开启全局事务</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>beginTransaction<span style=color:#666>(</span>txInfo<span style=color:#666>,</span> tx<span style=color:#666>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> String <span style=color:#00a000>begin</span><span style=color:#666>(</span>String applicationId<span style=color:#666>,</span> String transactionServiceGroup<span style=color:#666>,</span> String name<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>int</span> timeout<span style=color:#666>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        GlobalBeginRequest request <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> GlobalBeginRequest<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        request<span style=color:#666>.</span><span style=color:#b44>setTransactionName</span><span style=color:#666>(</span>name<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        request<span style=color:#666>.</span><span style=color:#b44>setTimeout</span><span style=color:#666>(</span>timeout<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        GlobalBeginResponse response <span style=color:#666>=</span> <span style=color:#666>(</span>GlobalBeginResponse<span style=color:#666>)</span> syncCall<span style=color:#666>(</span>request<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>response<span style=color:#666>.</span><span style=color:#b44>getResultCode</span><span style=color:#666>()</span> <span style=color:#666>==</span> ResultCode<span style=color:#666>.</span><span style=color:#b44>Failed</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TmTransactionException<span style=color:#666>(</span>TransactionExceptionCode<span style=color:#666>.</span><span style=color:#b44>BeginFailed</span><span style=color:#666>,</span> response<span style=color:#666>.</span><span style=color:#b44>getMsg</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> response<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>注册开启全局事务，如果是第一连接seata-server还是注册TM</p><p>服务端逻辑 注册TM channel io.seata.core.rpc.netty.ChannelManager#registerTMChannel</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>registerTMChannel</span><span style=color:#666>(</span>RegisterTMRequest request<span style=color:#666>,</span> Channel channel<span style=color:#666>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>throws</span> IncompatibleVersionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        Version<span style=color:#666>.</span><span style=color:#b44>checkVersion</span><span style=color:#666>(</span>request<span style=color:#666>.</span><span style=color:#b44>getVersion</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        RpcContext rpcContext <span style=color:#666>=</span> buildChannelHolder<span style=color:#666>(</span>NettyPoolKey<span style=color:#666>.</span><span style=color:#b44>TransactionRole</span><span style=color:#666>.</span><span style=color:#b44>TMROLE</span><span style=color:#666>,</span> request<span style=color:#666>.</span><span style=color:#b44>getVersion</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>            request<span style=color:#666>.</span><span style=color:#b44>getApplicationId</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>            request<span style=color:#666>.</span><span style=color:#b44>getTransactionServiceGroup</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> channel<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        rpcContext<span style=color:#666>.</span><span style=color:#b44>holdInIdentifiedChannels</span><span style=color:#666>(</span>IDENTIFIED_CHANNELS<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        String clientIdentified <span style=color:#666>=</span> rpcContext<span style=color:#666>.</span><span style=color:#b44>getApplicationId</span><span style=color:#666>()</span> <span style=color:#666>+</span> Constants<span style=color:#666>.</span><span style=color:#b44>CLIENT_ID_SPLIT_CHAR</span>
</span></span><span style=display:flex><span>            <span style=color:#666>+</span> ChannelUtil<span style=color:#666>.</span><span style=color:#b44>getClientIpFromChannel</span><span style=color:#666>(</span>channel<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        ConcurrentMap<span style=color:#666>&lt;</span>Integer<span style=color:#666>,</span> RpcContext<span style=color:#666>&gt;</span> clientIdentifiedMap <span style=color:#666>=</span> CollectionUtils<span style=color:#666>.</span><span style=color:#b44>computeIfAbsent</span><span style=color:#666>(</span>TM_CHANNELS<span style=color:#666>,</span>
</span></span><span style=display:flex><span>            clientIdentified<span style=color:#666>,</span> key <span style=color:#666>-&gt;</span> <span style=color:#a2f;font-weight:700>new</span> ConcurrentHashMap<span style=color:#666>&lt;&gt;());</span>
</span></span><span style=display:flex><span>        rpcContext<span style=color:#666>.</span><span style=color:#b44>holdInClientChannels</span><span style=color:#666>(</span>clientIdentifiedMap<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>开启全局事务</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> String <span style=color:#00a000>begin</span><span style=color:#666>(</span>String applicationId<span style=color:#666>,</span> String transactionServiceGroup<span style=color:#666>,</span> String name<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>int</span> timeout<span style=color:#666>)</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        GlobalSession session <span style=color:#666>=</span> GlobalSession<span style=color:#666>.</span><span style=color:#b44>createGlobalSession</span><span style=color:#666>(</span>applicationId<span style=color:#666>,</span> transactionServiceGroup<span style=color:#666>,</span> name<span style=color:#666>,</span>
</span></span><span style=display:flex><span>            timeout<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        MDC<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>RootContext<span style=color:#666>.</span><span style=color:#b44>MDC_KEY_XID</span><span style=color:#666>,</span> session<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        session<span style=color:#666>.</span><span style=color:#b44>addSessionLifecycleListener</span><span style=color:#666>(</span>SessionHolder<span style=color:#666>.</span><span style=color:#b44>getRootSessionManager</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        session<span style=color:#666>.</span><span style=color:#b44>begin</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>// transaction start event
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        eventBus<span style=color:#666>.</span><span style=color:#b44>post</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> GlobalTransactionEvent<span style=color:#666>(</span>session<span style=color:#666>.</span><span style=color:#b44>getTransactionId</span><span style=color:#666>(),</span> GlobalTransactionEvent<span style=color:#666>.</span><span style=color:#b44>ROLE_TC</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>            session<span style=color:#666>.</span><span style=color:#b44>getTransactionName</span><span style=color:#666>(),</span> applicationId<span style=color:#666>,</span> transactionServiceGroup<span style=color:#666>,</span> session<span style=color:#666>.</span><span style=color:#b44>getBeginTime</span><span style=color:#666>(),</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> session<span style=color:#666>.</span><span style=color:#b44>getStatus</span><span style=color:#666>()));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> session<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>创建globalSession，返回xid 服务端还要对session进行管理，放入sessionMap进行管理</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>addGlobalSession</span><span style=color:#666>(</span>GlobalSession session<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>super</span><span style=color:#666>.</span><span style=color:#b44>addGlobalSession</span><span style=color:#666>(</span>session<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        sessionMap<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>session<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> session<span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=执行业务逻辑>执行业务逻辑</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>rs <span style=color:#666>=</span> business<span style=color:#666>.</span><span style=color:#b44>execute</span><span style=color:#666>();</span>
</span></span></code></pre></div><p>开始业务代码逻辑，在TCC模式下，一般会执行各个业务系统的prepare方法 前面已经说了对于reference service会使用TccActionInterceptor进行代理</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Object <span style=color:#00a000>invoke</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>final</span> MethodInvocation invocation<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> Throwable <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                Object<span style=color:#666>[]</span> methodArgs <span style=color:#666>=</span> invocation<span style=color:#666>.</span><span style=color:#b44>getArguments</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//Handler the TCC Aspect
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> ret <span style=color:#666>=</span> actionInterceptorHandler<span style=color:#666>.</span><span style=color:#b44>proceed</span><span style=color:#666>(</span>method<span style=color:#666>,</span> methodArgs<span style=color:#666>,</span> xid<span style=color:#666>,</span> businessAction<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                        invocation<span style=color:#666>::</span>proceed<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//return the final result
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>return</span> ret<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>Constants<span style=color:#666>.</span><span style=color:#b44>TCC_METHOD_RESULT</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//if not TCC, unbind branchType
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>BranchType<span style=color:#666>.</span><span style=color:#b44>TCC</span> <span style=color:#666>!=</span> previousBranchType<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    RootContext<span style=color:#666>.</span><span style=color:#b44>unbindBranchType</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>//MDC remove branchId
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                MDC<span style=color:#666>.</span><span style=color:#b44>remove</span><span style=color:#666>(</span>RootContext<span style=color:#666>.</span><span style=color:#b44>MDC_KEY_BRANCH_ID</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> invocation<span style=color:#666>.</span><span style=color:#b44>proceed</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span> <span style=color:#a2f;font-weight:700>protected</span> String <span style=color:#00a000>doTccActionLogStore</span><span style=color:#666>(</span>Method method<span style=color:#666>,</span> Object<span style=color:#666>[]</span> arguments<span style=color:#666>,</span> TwoPhaseBusinessAction businessAction<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                         BusinessActionContext actionContext<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        String actionName <span style=color:#666>=</span> actionContext<span style=color:#666>.</span><span style=color:#b44>getActionName</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        String xid <span style=color:#666>=</span> actionContext<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> context <span style=color:#666>=</span> fetchActionRequestContext<span style=color:#666>(</span>method<span style=color:#666>,</span> arguments<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        context<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>Constants<span style=color:#666>.</span><span style=color:#b44>ACTION_START_TIME</span><span style=color:#666>,</span> System<span style=color:#666>.</span><span style=color:#b44>currentTimeMillis</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//init business context
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        initBusinessContext<span style=color:#666>(</span>context<span style=color:#666>,</span> method<span style=color:#666>,</span> businessAction<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//Init running environment context
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        initFrameworkContext<span style=color:#666>(</span>context<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        actionContext<span style=color:#666>.</span><span style=color:#b44>setActionContext</span><span style=color:#666>(</span>context<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>//init applicationData
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> applicationContext <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;(</span><span style=color:#666>4</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        applicationContext<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>Constants<span style=color:#666>.</span><span style=color:#b44>TCC_ACTION_CONTEXT</span><span style=color:#666>,</span> context<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        String applicationContextStr <span style=color:#666>=</span> JSON<span style=color:#666>.</span><span style=color:#b44>toJSONString</span><span style=color:#666>(</span>applicationContext<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>//registry branch record
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            Long branchId <span style=color:#666>=</span> DefaultResourceManager<span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>().</span><span style=color:#b44>branchRegister</span><span style=color:#666>(</span>BranchType<span style=color:#666>.</span><span style=color:#b44>TCC</span><span style=color:#666>,</span> actionName<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> xid<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                applicationContextStr<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> String<span style=color:#666>.</span><span style=color:#b44>valueOf</span><span style=color:#666>(</span>branchId<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable t<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            String msg <span style=color:#666>=</span> String<span style=color:#666>.</span><span style=color:#b44>format</span><span style=color:#666>(</span><span style=color:#b44>&#34;TCC branch Register error, xid: %s&#34;</span><span style=color:#666>,</span> xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span>msg<span style=color:#666>,</span> t<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> FrameworkException<span style=color:#666>(</span>t<span style=color:#666>,</span> msg<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>需要开始分支事务 ，需要发送事务的相关信息到服务端 {“actionContext”:{“a”:1,“action-start-time”:1659771487917,“sys::prepare”:“prepare”,“sys::rollback”:“rollback”,“sys::commit”:“commit”,“host-name”:“10.100.100.27”,“actionName”:“DubboTccActionOne”}} 读取的信息为接口注解上的信息 <img src=https://img-blog.csdnimg.cn/f1ca47bce78945a79fb3340f14349767.png alt=img></p><p>刚好RM在启动时，也把对应的信息注册到了服务端。 分支事务开启服务端逻辑 io.seata.server.coordinator.AbstractCore#branchRegister</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> Long <span style=color:#00a000>branchRegister</span><span style=color:#666>(</span>BranchType branchType<span style=color:#666>,</span> String resourceId<span style=color:#666>,</span> String clientId<span style=color:#666>,</span> String xid<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                               String applicationData<span style=color:#666>,</span> String lockKeys<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        GlobalSession globalSession <span style=color:#666>=</span> assertGlobalSessionNotNull<span style=color:#666>(</span>xid<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> SessionHolder<span style=color:#666>.</span><span style=color:#b44>lockAndExecute</span><span style=color:#666>(</span>globalSession<span style=color:#666>,</span> <span style=color:#666>()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            globalSessionStatusCheck<span style=color:#666>(</span>globalSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            globalSession<span style=color:#666>.</span><span style=color:#b44>addSessionLifecycleListener</span><span style=color:#666>(</span>SessionHolder<span style=color:#666>.</span><span style=color:#b44>getRootSessionManager</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            BranchSession branchSession <span style=color:#666>=</span> SessionHelper<span style=color:#666>.</span><span style=color:#b44>newBranchByGlobal</span><span style=color:#666>(</span>globalSession<span style=color:#666>,</span> branchType<span style=color:#666>,</span> resourceId<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    applicationData<span style=color:#666>,</span> lockKeys<span style=color:#666>,</span> clientId<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            MDC<span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>RootContext<span style=color:#666>.</span><span style=color:#b44>MDC_KEY_BRANCH_ID</span><span style=color:#666>,</span> String<span style=color:#666>.</span><span style=color:#b44>valueOf</span><span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>()));</span>
</span></span><span style=display:flex><span>            branchSessionLock<span style=color:#666>(</span>globalSession<span style=color:#666>,</span> branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                globalSession<span style=color:#666>.</span><span style=color:#b44>addBranch</span><span style=color:#666>(</span>branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>RuntimeException ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                branchSessionUnlock<span style=color:#666>(</span>branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> BranchTransactionException<span style=color:#666>(</span>FailedToAddBranch<span style=color:#666>,</span> String
</span></span><span style=display:flex><span>                        <span style=color:#666>.</span><span style=color:#b44>format</span><span style=color:#666>(</span><span style=color:#b44>&#34;Failed to store branch xid = %s branchId = %s&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>                                branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>()),</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>LOGGER<span style=color:#666>.</span><span style=color:#b44>isInfoEnabled</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Register branch successfully, xid = {}, branchId = {}, resourceId = {} ,lockKeys = {}&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>(),</span> resourceId<span style=color:#666>,</span> lockKeys<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>});</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>创建一个BranchSession添加的GlobalSession下面这里注意 branchSessionLock(globalSession, branchSession);这个方法 <img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/9caac3cc4636465b9d8e974c7527e745.png alt=img></p><p>发现只有在AT模式才有实现，<strong>也就是说TCC模式时没有对数据库上锁的操作的</strong>。 开启分支支付后远程调用dubbo服务。执行业务逻辑</p><h2 id=异常回滚>异常回滚</h2><ol><li>prepare阶段异常</li></ol><p>prepare指的时业务代码导致的异常，事务发起者TM会发起异常回滚的请求</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>rollback</span><span style=color:#666>()</span> <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>role <span style=color:#666>==</span> GlobalTransactionRole<span style=color:#666>.</span><span style=color:#b44>Participant</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>// Participant has no responsibility of rollback
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>LOGGER<span style=color:#666>.</span><span style=color:#b44>isDebugEnabled</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                LOGGER<span style=color:#666>.</span><span style=color:#b44>debug</span><span style=color:#666>(</span><span style=color:#b44>&#34;Ignore Rollback(): just involved in global transaction [{}]&#34;</span><span style=color:#666>,</span> xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        assertXIDNotNull<span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#0b0;font-weight:700>int</span> retry <span style=color:#666>=</span> ROLLBACK_RETRY_COUNT <span style=color:#666>&lt;=</span> <span style=color:#666>0</span> <span style=color:#666>?</span> DEFAULT_TM_ROLLBACK_RETRY_COUNT <span style=color:#666>:</span> ROLLBACK_RETRY_COUNT<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(</span>retry <span style=color:#666>&gt;</span> <span style=color:#666>0</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    status <span style=color:#666>=</span> transactionManager<span style=color:#666>.</span><span style=color:#b44>rollback</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;Failed to report global rollback [{}],Retry Countdown: {}, reason: {}&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> retry<span style=color:#666>,</span> ex<span style=color:#666>.</span><span style=color:#b44>getMessage</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                    retry<span style=color:#666>--;</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>retry <span style=color:#666>==</span> <span style=color:#666>0</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span><span style=color:#b44>&#34;Failed to report global rollback&#34;</span><span style=color:#666>,</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>xid<span style=color:#666>.</span><span style=color:#b44>equals</span><span style=color:#666>(</span>RootContext<span style=color:#666>.</span><span style=color:#b44>getXID</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                suspend<span style=color:#666>();</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>LOGGER<span style=color:#666>.</span><span style=color:#b44>isInfoEnabled</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;[{}] rollback status: {}&#34;</span><span style=color:#666>,</span> xid<span style=color:#666>,</span> status<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> GlobalStatus <span style=color:#00a000>rollback</span><span style=color:#666>(</span>String xid<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        GlobalRollbackRequest globalRollback <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> GlobalRollbackRequest<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        globalRollback<span style=color:#666>.</span><span style=color:#b44>setXid</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        GlobalRollbackResponse response <span style=color:#666>=</span> <span style=color:#666>(</span>GlobalRollbackResponse<span style=color:#666>)</span> syncCall<span style=color:#666>(</span>globalRollback<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> response<span style=color:#666>.</span><span style=color:#b44>getGlobalStatus</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>看的出，如果请求回滚失败，会重试，并且有一个重试次数 默认5此，如果发生已成，会继续重试，并且这是一个同步请求。直到服务端确认失败或者成功才能返回。 服务端逻辑 io.seata.server.coordinator.DefaultCore#rollback</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> GlobalStatus <span style=color:#00a000>rollback</span><span style=color:#666>(</span>String xid<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        GlobalSession globalSession <span style=color:#666>=</span> SessionHolder<span style=color:#666>.</span><span style=color:#b44>findGlobalSession</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>globalSession <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> GlobalStatus<span style=color:#666>.</span><span style=color:#b44>Finished</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        globalSession<span style=color:#666>.</span><span style=color:#b44>addSessionLifecycleListener</span><span style=color:#666>(</span>SessionHolder<span style=color:#666>.</span><span style=color:#b44>getRootSessionManager</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>// just lock changeStatus
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>        <span style=color:#0b0;font-weight:700>boolean</span> shouldRollBack <span style=color:#666>=</span> SessionHolder<span style=color:#666>.</span><span style=color:#b44>lockAndExecute</span><span style=color:#666>(</span>globalSession<span style=color:#666>,</span> <span style=color:#666>()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            globalSession<span style=color:#666>.</span><span style=color:#b44>close</span><span style=color:#666>();</span> <span style=color:#080;font-style:italic>// Highlight: Firstly, close the session, then no more branch can be registered.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>globalSession<span style=color:#666>.</span><span style=color:#b44>getStatus</span><span style=color:#666>()</span> <span style=color:#666>==</span> GlobalStatus<span style=color:#666>.</span><span style=color:#b44>Begin</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                globalSession<span style=color:#666>.</span><span style=color:#b44>changeStatus</span><span style=color:#666>(</span>GlobalStatus<span style=color:#666>.</span><span style=color:#b44>Rollbacking</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>});</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>shouldRollBack<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getStatus</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        doGlobalRollback<span style=color:#666>(</span>globalSession<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getStatus</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>更改globalSession状态为GlobalStatus.Rollbacking 然后进入doGlobalRollback 循环分支事务，分别进行回滚操作</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Boolean result <span style=color:#666>=</span> SessionHelper<span style=color:#666>.</span><span style=color:#b44>forEach</span><span style=color:#666>(</span>globalSession<span style=color:#666>.</span><span style=color:#b44>getReverseSortedBranches</span><span style=color:#666>(),</span> branchSession <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                BranchStatus currentBranchStatus <span style=color:#666>=</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getStatus</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>currentBranchStatus <span style=color:#666>==</span> BranchStatus<span style=color:#666>.</span><span style=color:#b44>PhaseOne_Failed</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    globalSession<span style=color:#666>.</span><span style=color:#b44>removeBranch</span><span style=color:#666>(</span>branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    BranchStatus branchStatus <span style=color:#666>=</span> branchRollback<span style=color:#666>(</span>globalSession<span style=color:#666>,</span> branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>switch</span> <span style=color:#666>(</span>branchStatus<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>case</span> PhaseTwo_Rollbacked<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            globalSession<span style=color:#666>.</span><span style=color:#b44>removeBranch</span><span style=color:#666>(</span>branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Rollback branch transaction successfully, xid = {} branchId = {}&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>case</span> PhaseTwo_RollbackFailed_Unretryable<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            SessionHelper<span style=color:#666>.</span><span style=color:#b44>endRollbackFailed</span><span style=color:#666>(</span>globalSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Rollback branch transaction fail and stop retry, xid = {} branchId = {}&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>default</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Rollback branch transaction fail and will retry, xid = {} branchId = {}&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>retrying<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                globalSession<span style=color:#666>.</span><span style=color:#b44>queueToRetryRollback</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Exception ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    StackTraceLogger<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span>LOGGER<span style=color:#666>,</span> ex<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#b44>&#34;Rollback branch transaction exception, xid = {} branchId = {} exception = {}&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>new</span> String<span style=color:#666>[]</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> String<span style=color:#666>.</span><span style=color:#b44>valueOf</span><span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>()),</span> ex<span style=color:#666>.</span><span style=color:#b44>getMessage</span><span style=color:#666>()});</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>retrying<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        globalSession<span style=color:#666>.</span><span style=color:#b44>queueToRetryRollback</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span>ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> BranchStatus <span style=color:#00a000>branchRollback</span><span style=color:#666>(</span>GlobalSession globalSession<span style=color:#666>,</span> BranchSession branchSession<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            BranchRollbackRequest request <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> BranchRollbackRequest<span style=color:#666>();</span>
</span></span><span style=display:flex><span>            request<span style=color:#666>.</span><span style=color:#b44>setXid</span><span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            request<span style=color:#666>.</span><span style=color:#b44>setBranchId</span><span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            request<span style=color:#666>.</span><span style=color:#b44>setResourceId</span><span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getResourceId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            request<span style=color:#666>.</span><span style=color:#b44>setApplicationData</span><span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getApplicationData</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            request<span style=color:#666>.</span><span style=color:#b44>setBranchType</span><span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchType</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span> branchRollbackSend<span style=color:#666>(</span>request<span style=color:#666>,</span> globalSession<span style=color:#666>,</span> branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>IOException <span style=color:#666>|</span> TimeoutException e<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> BranchTransactionException<span style=color:#666>(</span>FailedToSendBranchRollbackRequest<span style=color:#666>,</span>
</span></span><span style=display:flex><span>                    String<span style=color:#666>.</span><span style=color:#b44>format</span><span style=color:#666>(</span><span style=color:#b44>&#34;Send branch rollback failed, xid = %s branchId = %s&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                            branchSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>()),</span> e<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>分别给分支事务资源对应的RM发送回滚消息（RM已经把资源注册到seata-server,因此seata-server可以根据资源找到对应的rm），同样是同步消息。 RM根据rolllback返回值判断是否回滚成功。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>return</span> result <span style=color:#666>?</span> BranchStatus<span style=color:#666>.</span><span style=color:#b44>PhaseTwo_Rollbacked</span> <span style=color:#666>:</span> BranchStatus<span style=color:#666>.</span><span style=color:#b44>PhaseTwo_RollbackFailed_Retryable</span><span style=color:#666>;</span>
</span></span></code></pre></div><p>针对回滚的不同状态有不同的操作</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>switch</span> <span style=color:#666>(</span>branchStatus<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>              <span style=color:#080;font-style:italic>// 回滚成功，移除分支事务
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        <span style=color:#a2f;font-weight:700>case</span> PhaseTwo_Rollbacked<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            globalSession<span style=color:#666>.</span><span style=color:#b44>removeBranch</span><span style=color:#666>(</span>branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Rollback branch transaction successfully, xid = {} branchId = {}&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>             <span style=color:#080;font-style:italic>// 回滚失败，并且无法重试 ，会将globalSession的状态设置为  
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                        <span style=color:#a2f;font-weight:700>case</span> PhaseTwo_RollbackFailed_Unretryable<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            SessionHelper<span style=color:#666>.</span><span style=color:#b44>endRollbackFailed</span><span style=color:#666>(</span>globalSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Rollback branch transaction fail and stop retry, xid = {} branchId = {}&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>default</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>             <span style=color:#080;font-style:italic>// 回滚失败。globalSession放入重试队列进行重试回滚
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Rollback branch transaction fail and will retry, xid = {} branchId = {}&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>retrying<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                globalSession<span style=color:#666>.</span><span style=color:#b44>queueToRetryRollback</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span></code></pre></div><p>看下定时任务的处理重试回滚队列的逻辑</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>protected</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>handleRetryRollbacking</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        Collection<span style=color:#666>&lt;</span>GlobalSession<span style=color:#666>&gt;</span> rollbackingSessions <span style=color:#666>=</span> SessionHolder<span style=color:#666>.</span><span style=color:#b44>getRetryRollbackingSessionManager</span><span style=color:#666>().</span><span style=color:#b44>allSessions</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>CollectionUtils<span style=color:#666>.</span><span style=color:#b44>isEmpty</span><span style=color:#666>(</span>rollbackingSessions<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#0b0;font-weight:700>long</span> now <span style=color:#666>=</span> System<span style=color:#666>.</span><span style=color:#b44>currentTimeMillis</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>        SessionHelper<span style=color:#666>.</span><span style=color:#b44>forEach</span><span style=color:#666>(</span>rollbackingSessions<span style=color:#666>,</span> rollbackingSession <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>// prevent repeated rollback
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>rollbackingSession<span style=color:#666>.</span><span style=color:#b44>getStatus</span><span style=color:#666>().</span><span style=color:#b44>equals</span><span style=color:#666>(</span>GlobalStatus<span style=color:#666>.</span><span style=color:#b44>Rollbacking</span><span style=color:#666>)</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#666>!</span>rollbackingSession<span style=color:#666>.</span><span style=color:#b44>isDeadSession</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>//The function of this &#39;return&#39; is &#39;continue&#39;.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>isRetryTimeout<span style=color:#666>(</span>now<span style=color:#666>,</span> MAX_ROLLBACK_RETRY_TIMEOUT<span style=color:#666>.</span><span style=color:#b44>toMillis</span><span style=color:#666>(),</span> rollbackingSession<span style=color:#666>.</span><span style=color:#b44>getBeginTime</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>ROLLBACK_RETRY_TIMEOUT_UNLOCK_ENABLE<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        rollbackingSession<span style=color:#666>.</span><span style=color:#b44>clean</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>                     * Prevent thread safety issues
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>                     */</span>
</span></span><span style=display:flex><span>                    SessionHolder<span style=color:#666>.</span><span style=color:#b44>getRetryRollbackingSessionManager</span><span style=color:#666>().</span><span style=color:#b44>removeGlobalSession</span><span style=color:#666>(</span>rollbackingSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Global transaction rollback retry timeout and has removed [{}]&#34;</span><span style=color:#666>,</span> rollbackingSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                    <span style=color:#080;font-style:italic>//The function of this &#39;return&#39; is &#39;continue&#39;.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                    <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                rollbackingSession<span style=color:#666>.</span><span style=color:#b44>addSessionLifecycleListener</span><span style=color:#666>(</span>SessionHolder<span style=color:#666>.</span><span style=color:#b44>getRootSessionManager</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                core<span style=color:#666>.</span><span style=color:#b44>doGlobalRollback</span><span style=color:#666>(</span>rollbackingSession<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>TransactionException ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;Failed to retry rollbacking [{}] {} {}&#34;</span><span style=color:#666>,</span> rollbackingSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> ex<span style=color:#666>.</span><span style=color:#b44>getCode</span><span style=color:#666>(),</span> ex<span style=color:#666>.</span><span style=color:#b44>getMessage</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>});</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>默认为永不超时。可以通过配置</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     * The constant MAX_ROLLBACK_RETRY_TIMEOUT.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    String MAX_ROLLBACK_RETRY_TIMEOUT <span style=color:#666>=</span> SERVER_PREFIX <span style=color:#666>+</span> <span style=color:#b44>&#34;maxRollbackRetryTimeout&#34;</span><span style=color:#666>;</span>
</span></span></code></pre></div><p>，也就是说如果一直回滚失败，就会一直重。</p><p>再回到TM的rollback方法，如果收到了seata-server的回复就结束循环了，虽然此时可能并没有完成回滚，但是剩下的就交给seata-server进行不断的回滚重试。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(</span>retry <span style=color:#666>&gt;</span> <span style=color:#666>0</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    status <span style=color:#666>=</span> transactionManager<span style=color:#666>.</span><span style=color:#b44>rollback</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;Failed to report global rollback [{}],Retry Countdown: {}, reason: {}&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> retry<span style=color:#666>,</span> ex<span style=color:#666>.</span><span style=color:#b44>getMessage</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                    retry<span style=color:#666>--;</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>retry <span style=color:#666>==</span> <span style=color:#666>0</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span><span style=color:#b44>&#34;Failed to report global rollback&#34;</span><span style=color:#666>,</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span></code></pre></div><ol><li>事务超时回滚</li></ol><p>检测事务超时，检测全局事务的回滚状态 定时任务io.seata.server.coordinator.DefaultCoordinator#timeoutCheck，默认5秒检测一次</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>isTimeout</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>(</span>System<span style=color:#666>.</span><span style=color:#b44>currentTimeMillis</span><span style=color:#666>()</span> <span style=color:#666>-</span> beginTime<span style=color:#666>)</span> <span style=color:#666>&gt;</span> timeout<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><h2 id=事务提交>事务提交</h2><p>事务提交一定是由TM发起</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#080;font-style:italic>// 4. everything is fine, commit.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                commitTransaction<span style=color:#666>(</span>tx<span style=color:#666>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>commit</span><span style=color:#666>()</span> <span style=color:#a2f;font-weight:700>throws</span> TransactionException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>role <span style=color:#666>==</span> GlobalTransactionRole<span style=color:#666>.</span><span style=color:#b44>Participant</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#080;font-style:italic>// Participant has no responsibility of committing
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>LOGGER<span style=color:#666>.</span><span style=color:#b44>isDebugEnabled</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                LOGGER<span style=color:#666>.</span><span style=color:#b44>debug</span><span style=color:#666>(</span><span style=color:#b44>&#34;Ignore Commit(): just involved in global transaction [{}]&#34;</span><span style=color:#666>,</span> xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        assertXIDNotNull<span style=color:#666>();</span>
</span></span><span style=display:flex><span>        <span style=color:#0b0;font-weight:700>int</span> retry <span style=color:#666>=</span> COMMIT_RETRY_COUNT <span style=color:#666>&lt;=</span> <span style=color:#666>0</span> <span style=color:#666>?</span> DEFAULT_TM_COMMIT_RETRY_COUNT <span style=color:#666>:</span> COMMIT_RETRY_COUNT<span style=color:#666>;</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>(</span>retry <span style=color:#666>&gt;</span> <span style=color:#666>0</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    status <span style=color:#666>=</span> transactionManager<span style=color:#666>.</span><span style=color:#b44>commit</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>break</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;Failed to report global commit [{}],Retry Countdown: {}, reason: {}&#34;</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> retry<span style=color:#666>,</span> ex<span style=color:#666>.</span><span style=color:#b44>getMessage</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                    retry<span style=color:#666>--;</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>retry <span style=color:#666>==</span> <span style=color:#666>0</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span><span style=color:#b44>&#34;Failed to report global commit&#34;</span><span style=color:#666>,</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>xid<span style=color:#666>.</span><span style=color:#b44>equals</span><span style=color:#666>(</span>RootContext<span style=color:#666>.</span><span style=color:#b44>getXID</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                suspend<span style=color:#666>();</span>
</span></span><span style=display:flex><span>            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>LOGGER<span style=color:#666>.</span><span style=color:#b44>isInfoEnabled</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>            LOGGER<span style=color:#666>.</span><span style=color:#b44>info</span><span style=color:#666>(</span><span style=color:#b44>&#34;[{}] commit status: {}&#34;</span><span style=color:#666>,</span> xid<span style=color:#666>,</span> status<span style=color:#666>);</span>
</span></span><span style=display:flex><span>        <span style=color:#666>}</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span></code></pre></div><p>向seata-server发送提交全局事务的请求，异常也会重试。 再看服务端的提交逻辑</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Boolean result <span style=color:#666>=</span> SessionHelper<span style=color:#666>.</span><span style=color:#b44>forEach</span><span style=color:#666>(</span>globalSession<span style=color:#666>.</span><span style=color:#b44>getSortedBranches</span><span style=color:#666>(),</span> branchSession <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                <span style=color:#080;font-style:italic>// if not retrying, skip the canBeCommittedAsync branches
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>retrying <span style=color:#666>&amp;&amp;</span> branchSession<span style=color:#666>.</span><span style=color:#b44>canBeCommittedAsync</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                BranchStatus currentStatus <span style=color:#666>=</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getStatus</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>currentStatus <span style=color:#666>==</span> BranchStatus<span style=color:#666>.</span><span style=color:#b44>PhaseOne_Failed</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    globalSession<span style=color:#666>.</span><span style=color:#b44>removeBranch</span><span style=color:#666>(</span>branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    BranchStatus branchStatus <span style=color:#666>=</span> getCore<span style=color:#666>(</span>branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchType</span><span style=color:#666>()).</span><span style=color:#b44>branchCommit</span><span style=color:#666>(</span>globalSession<span style=color:#666>,</span> branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>switch</span> <span style=color:#666>(</span>branchStatus<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>case</span> PhaseTwo_Committed<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            globalSession<span style=color:#666>.</span><span style=color:#b44>removeBranch</span><span style=color:#666>(</span>branchSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>case</span> PhaseTwo_CommitFailed_Unretryable<span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>globalSession<span style=color:#666>.</span><span style=color:#b44>canBeCommittedAsync</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>                                    <span style=color:#b44>&#34;Committing branch transaction[{}], status: PhaseTwo_CommitFailed_Unretryable, please check the business log.&#34;</span><span style=color:#666>,</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                SessionHelper<span style=color:#666>.</span><span style=color:#b44>endCommitFailed</span><span style=color:#666>(</span>globalSession<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                                LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;Committing global transaction[{}] finally failed, caused by branch transaction[{}] commit failed.&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>default</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>retrying<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                globalSession<span style=color:#666>.</span><span style=color:#b44>queueToRetryCommit</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                            <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>globalSession<span style=color:#666>.</span><span style=color:#b44>canBeCommittedAsync</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span><span style=color:#b44>&#34;Committing branch transaction[{}], status:{} and will retry later&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                    branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>(),</span> branchStatus<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                                LOGGER<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>                                    <span style=color:#b44>&#34;Committing global transaction[{}] failed, caused by branch transaction[{}] commit failed, will retry later.&#34;</span><span style=color:#666>,</span> globalSession<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>(),</span> branchSession<span style=color:#666>.</span><span style=color:#b44>getBranchId</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>                                <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Exception ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                    StackTraceLogger<span style=color:#666>.</span><span style=color:#b44>error</span><span style=color:#666>(</span>LOGGER<span style=color:#666>,</span> ex<span style=color:#666>,</span> <span style=color:#b44>&#34;Committing branch transaction exception: {}&#34;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>new</span> String<span style=color:#666>[]</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   branchSession<span style=color:#666>.</span><span style=color:#b44>toString</span><span style=color:#666>()});</span>
</span></span><span style=display:flex><span>                    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>retrying<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>                        globalSession<span style=color:#666>.</span><span style=color:#b44>queueToRetryCommit</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> TransactionException<span style=color:#666>(</span>ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#666>}</span>
</span></span><span style=display:flex><span>                <span style=color:#a2f;font-weight:700>return</span> CONTINUE<span style=color:#666>;</span>
</span></span><span style=display:flex><span>            <span style=color:#666>});</span>
</span></span></code></pre></div><p>和回滚一样，挨个分支事务尝试回滚，执行对应的commit方法，成功移除分支事务，如果回滚失败会将加入重试队列重试提交</p><p>实现TCC事务模型涉及到的三个异常是不可避免的，实际生产中必须要规避这三大异常。</p><p><strong>1、空回滚</strong></p><p>定义：在未调用try方法或try方法未执行成功的情况下，就执行了cancel方法进行了回滚。 怎么理解呢？未调用try方法就执行了cancel方法，这个很容易理解，既然没有预留资源，那么肯定是不能回滚。 try方法未执行成功是什么意思？ 可以看上节中的第一阶段try方法的伪代码，由于try方法开启了本地事务，一旦try方法执行过程中出现了异常，将会导致try方法的本地事务回滚（注意这里不是cancel方法回滚，而是try方法的本地事务回滚），这样其实try方法中的所有操作都将会回滚，也就没有必要调用cancel方法。 但是实际上一旦try方法抛出了异常，那么必定是要调用cancel方法进行回滚，这样就导致了空回滚。 解决方案： 解决逻辑很简单：在cancel方法执行操作之前，必须要知道try方法是否执行成功。</p><p><strong>2、幂等性</strong></p><p>TCC模式定义中提到：如果confirm或者cancel方法执行失败，要一直重试直到成功。 这里就涉及了幂等性，confirm和cancel方法必须保证同一个全局事务中的幂等性。 解决方案： 解决逻辑很简单：对付幂等，自然是要利用幂等标识进行防重操作。</p><p><strong>3、悬挂</strong></p><p>悬挂是指因为网络问题，RM 开始没有收到 try 指令，但是执行了 Rollback 后 RM 又收到了 try 指令并且预留资源成功，这时全局事务已经结束，最终导致预留的资源不能释放。 事务协调器在调用 TCC 服务的一阶段 Try 操作时，<strong>可能会出现因网络拥堵而导致的超时，比如dubbo调用超时</strong>，此时事务管理器会触发二阶段回滚，调用 TCC 服务的 Cancel 操作，Cancel 调用未超时； 在此之后，拥堵在网络上的一阶段 Try 数据包被 TCC 服务收到，出现了二阶段 Cancel 请求比一阶段 Try 请求先执行的情况，此 TCC 服务在执行晚到的 Try 之后，将永远不会再收到二阶段的 Confirm 或者 Cancel ，造成 TCC 服务悬挂。 解决方案： 解决逻辑很简单：在执行try方法操作资源之前判断cancel方法是否已经执行；同样的在cancel方法执行后要记录执行的状态。 <strong>4、总结</strong> 针对以上三个异常，落地的解决方案很多，比如维护一个事务状态表，每个事务的执行阶段全部记录下来。 幂等：在执行confirm或者cancel之前根据事务状态表查询当前全局事务是否已经执行过confirm或者cancel方法 空回滚：在执行cancel之前才能根据事务状态表查询当前全局事务是否已经执行成功try方法 悬挂：在执行try方法之前，根据事务状态表查询当前全局事务是否已经执行过cancel方法</p><p><strong>本文使用的是1.4.2版本，源码中还没有这个机制</strong> 在 Seata1.5.0 版本中 ，增加了一张事务控制表，表名是 tcc_fence_log 来解决这个问题。而在上一节 @TwoPhaseBusinessAction 注解中提到的属性 useTCCFence 就是来指定是否开启这个机制，这个属性值默认是 false。 tcc_fence_log 建表语句如下（MySQL 语法）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>CREATE TABLE IF NOT EXISTS <span>`</span>tcc_fence_log<span>`</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>  <span>`</span>xid<span>`</span>           VARCHAR<span style=color:#666>(</span><span style=color:#666>128</span><span style=color:#666>)</span>  NOT NULL COMMENT <span>&#39;</span>global id<span>&#39;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>  <span>`</span>branch_id<span>`</span>     BIGINT        NOT NULL COMMENT <span>&#39;</span>branch id<span>&#39;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>  <span>`</span>action_name<span>`</span>   VARCHAR<span style=color:#666>(</span><span style=color:#666>64</span><span style=color:#666>)</span>   NOT NULL COMMENT <span>&#39;</span>action name<span>&#39;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>  <span>`</span>status<span>`</span>        TINYINT       NOT NULL COMMENT <span>&#39;</span>status<span style=color:#666>(</span>tried<span style=color:#666>:</span><span style=color:#666>1</span><span style=color:#666>;</span>committed<span style=color:#666>:</span><span style=color:#666>2</span><span style=color:#666>;</span>rollbacked<span style=color:#666>:</span><span style=color:#666>3</span><span style=color:#666>;</span>suspended<span style=color:#666>:</span><span style=color:#666>4</span><span style=color:#666>)</span><span>&#39;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>  <span>`</span>gmt_create<span>`</span>    DATETIME<span style=color:#666>(</span><span style=color:#666>3</span><span style=color:#666>)</span>   NOT NULL COMMENT <span>&#39;</span>create time<span>&#39;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>  <span>`</span>gmt_modified<span>`</span>  DATETIME<span style=color:#666>(</span><span style=color:#666>3</span><span style=color:#666>)</span>   NOT NULL COMMENT <span>&#39;</span>update time<span>&#39;</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>  PRIMARY <span style=color:#00a000>KEY</span> <span style=color:#666>(</span><span>`</span>xid<span>`</span><span style=color:#666>,</span> <span>`</span>branch_id<span>`</span><span style=color:#666>),</span>
</span></span><span style=display:flex><span>  KEY <span>`</span>idx_gmt_modified<span>`</span> <span style=color:#666>(</span><span>`</span>gmt_modified<span>`</span><span style=color:#666>),</span>
</span></span><span style=display:flex><span>  KEY <span>`</span>idx_status<span>`</span> <span style=color:#666>(</span><span>`</span>status<span>`</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#666>)</span> ENGINE <span style=color:#666>=</span> InnoDB
</span></span><span style=display:flex><span>DEFAULT CHARSET <span style=color:#666>=</span> utf8mb4<span style=color:#666>;</span>
</span></span></code></pre></div><p><strong>保证幂等</strong> 提交事务时首先会判断 tcc_fence_log 表中是否已经有记录，如果有记录，则判断事务执行状态并返回。这样如果判断到事务的状态已经是 STATUS_COMMITTED，就不会再次提交，保证了幂等。如果 tcc_fence_log 表中没有记录，则插入一条记录，供后面重试时判断。</p><p>Rollback 的逻辑跟 commit 类似，逻辑在类 TCCFenceHandler 的 rollbackFence 方法。</p><p><strong>防止空回滚</strong> Seata 的解决方案是在 try 阶段 往 tcc_fence_log 表插入一条记录，status 字段值是 STATUS_TRIED，在 Rollback 阶段判断记录是否存在，如果不存在，则不执行回滚操作。</p><p><strong>防止悬挂</strong> Seata 解决这个问题的方法是执行 Rollback 方法时先判断 tcc_fence_log 是否存在当前 xid 的记录，如果没有则向 tcc_fence_log 表插入一条记录，状态是 STATUS_SUSPENDED，并且不再执行回滚操作。代码如下：</p></div><footer class=post-footer><div class=post-tags><a href=/tags/seata rel=tag title=Seata>#Seata#</a>
<a href=/tags/%e4%b8%ad%e9%97%b4%e4%bb%b6 rel=tag title=中间件>#中间件#</a>
<a href=/tags/%e5%88%86%e5%b8%83%e5%bc%8f rel=tag title=分布式>#分布式#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>Seata之TCC模式</p><p><span>链接：</span>https://codingroam.github.io/post/seata%E4%B9%8Btcc%E6%A8%A1%E5%BC%8F/</p><p><span>作者：</span>roam</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://codingroam.github.io/post/golang%E6%8E%A5%E5%8F%A3-%E6%8E%A5%E5%8F%A3%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%AF%94%E8%BE%83/ rel=next title=Golang接口-接口两种类型的比较><i class="fa fa-chevron-left"></i> Golang接口-接口两种类型的比较</a></div><div class="post-nav-prev post-nav-item"><a href=https://codingroam.github.io/post/golang-%E8%AF%AD%E8%A8%80%E8%A7%84%E8%8C%83%E4%B8%80/ rel=prev title="Golang 语言规范(一)——结构类型、接口类型与方法">Golang 语言规范(一)——结构类型、接口类型与方法
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=roam><p class=site-author-name itemprop=name>roam</p><p class="site-description motion-element" itemprop=description>以为打得赢我啊你</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>77</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>30</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>54</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/wk123456/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://www.zhihu.com/ target=_blank title=知乎><i class="fa fa-fw fa-globe"></i>
知乎</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://nutzam.com/ title=Nutz target=_blank>Nutz</a></li><li class=links-of-blogroll-item><a href=https://jfinal.com/ title=JFinal target=_blank>JFinal</a></li><li class=links-of-blogroll-item><a href=http://wendal.net/ title=Wendal target=_blank>Wendal</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/learning>Learning
<sup>27</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/java>Java
<sup>11</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql
<sup>11</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6>中间件
<sup>10</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/golang>Golang
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/golang%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0>Golang编程学习
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/linux>Linux
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/redis>Redis
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/problem-solving>Problem solving
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker
<sup>6</sup></a></li></ul></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>想学啊你</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.115.4</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://gitee.com/ style=font-weight:700 target=_blank>Gitee 仓库</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=http://beian.miit.gov.cn target=_blank>粤 ICP 备 18047355 号</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://codingroam.github.io/js/search.js></script>
<script type=text/javascript src=https://codingroam.github.io/js/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".footer").outerHeight(!0),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var e,t,n,s,o=$(".header-inner").height()+10;$("#sidebar").css({"margin-top":o}).show(),t=parseInt($("#sidebar").css("margin-top")),n=parseInt($(".sidebar-inner").css("height")),e=t+n,s=$(".content-wrap").height(),s<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>const locale={placeholder:"欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^"};$(function(){detectIE()>0?$.getScript(document.location.protocol+"//unpkg.com/@waline/client@1.6.0/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,emoji:[],wordLimit:"200",uploadImage:!1,locale,requiredMeta:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>