<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Seata四种模式（XA、AT、TCC、SAGA） - 好记性不如烂笔头</title><meta name=author content><meta name=author-link content><meta name=description content="Seata四种模式（XA、AT、TCC、SAGA）"><meta name=keywords content="分布式事务,中间件,Seata"><meta itemprop=name content="Seata四种模式（XA、AT、TCC、SAGA）"><meta itemprop=description content="Seata四种模式（XA、AT、TCC、SAGA）"><meta itemprop=datePublished content="2023-01-26T00:00:00+00:00"><meta itemprop=dateModified content="2023-01-26T00:00:00+00:00"><meta itemprop=wordCount content="3896"><meta itemprop=keywords content="分布式事务,中间件,Seata,"><meta property="og:title" content="Seata四种模式（XA、AT、TCC、SAGA）"><meta property="og:description" content="Seata四种模式（XA、AT、TCC、SAGA）"><meta property="og:type" content="article"><meta property="og:url" content="/post/seata%E5%9B%9B%E7%A7%8D%E6%A8%A1%E5%BC%8Fxaattccsaga/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Seata四种模式（XA、AT、TCC、SAGA）"><meta name=twitter:description content="Seata四种模式（XA、AT、TCC、SAGA）"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=/post/seata%E5%9B%9B%E7%A7%8D%E6%A8%A1%E5%BC%8Fxaattccsaga/><link rel=prev href=/post/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E4%B8%8E%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4/><link rel=next href=/post/docker%E4%B8%8Edocker-compose%E8%AF%A6%E8%A7%A3/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Seata四种模式（XA、AT、TCC、SAGA）","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"\/post\/seata%E5%9B%9B%E7%A7%8D%E6%A8%A1%E5%BC%8Fxaattccsaga\/"},"genre":"post","keywords":"分布式事务, 中间件, Seata","wordcount":3896,"url":"\/post\/seata%E5%9B%9B%E7%A7%8D%E6%A8%A1%E5%BC%8Fxaattccsaga\/","datePublished":"2023-01-26T00:00:00+00:00","dateModified":"2023-01-26T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"wang"},"description":"Seata四种模式（XA、AT、TCC、SAGA）"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=好记性不如烂笔头><img loading=lazy src=/fixit.min.svg srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" sizes=auto data-title=好记性不如烂笔头 data-alt=好记性不如烂笔头 class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>My Hugo FixIt Site</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/>home 首页</a></li><li class=menu-item><a class=menu-link href=/post>archive 归档</a></li><li class=menu-item><a class=menu-link href=/tag>tag 标签</a></li><li class=menu-item><a class=menu-link href=/categories>categories 目录</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li><li class="menu-item language-switch"><span role=button aria-label=选择语言 title=选择语言><i class="fa-solid fa-language fa-fw" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=好记性不如烂笔头><img loading=lazy src=/fixit.min.svg srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" sizes=auto data-title=/fixit.min.svg data-alt=/fixit.min.svg class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>My Hugo FixIt Site</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/>home 首页</a></li><li class=menu-item><a class=menu-link href=/post>archive 归档</a></li><li class=menu-item><a class=menu-link href=/tag>tag 标签</a></li><li class=menu-item><a class=menu-link href=/categories>categories 目录</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span><span class="menu-system-item language-switch">
<span role=button aria-label=选择语言 title=选择语言>中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></span></li></ul></nav></div></header><main class=container><article class="page single special"><div class=header><h1 class="single-title animate__animated animate__pulse animate__faster">Seata四种模式（XA、AT、TCC、SAGA）</h1></div><div class=content id=content><p>Seata四种模式（XA、AT、TCC、SAGA）</p><h1 id=seata四种模式xaattccsaga>Seata四种模式（XA、AT、TCC、SAGA）</h1><h3 id=1xa模式>1、XA模式</h3><h4 id=xa模式原理>XA模式原理：</h4><p>XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准，XA 规范 描述了全局的TM与局部的RM之间的接口，几乎所有主流的数据库都对 XA 规范 提供了支持。</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220152871.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220152871.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220152871.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220152871.png 2x" sizes=auto data-title=image-20230126220152871 data-alt=image-20230126220152871 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><blockquote><p>如果有失败的就会回滚事务</p></blockquote><h4 id=seata的xa模式>seata的XA模式</h4><p>seata的XA模式做了一些调整，但大体相似：</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220326443.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220326443.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220326443.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220326443.png 2x" sizes=auto data-title=image-20230126220326443 data-alt=image-20230126220326443 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>RM一阶段的工作：</p><ol><li>注册分支事务到TC</li><li>执行分支业务sql但不提交</li><li>报告执行状态到TC</li></ol><p>TC二阶段的工作：</p><ol><li><p>TC检测各分支事务执行状态</p></li><li><p>如果都成功，通知所有RM提交事务</p></li><li><p>如果有失败，通知所有RM回滚事务</p></li></ol><p>RM二阶段的工作：</p><ol><li>接收TC指令，提交或回滚事务</li></ol><p>xa模式的优点：</p><ol><li><p>事务的强一致性，满足ACID原则。</p></li><li><p>常用数据库都支持，实现简单，并且没有代码侵入</p></li></ol><p>xa模式的缺点：</p><ol><li>因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差
依赖关系型数据库实现事务</li></ol><p>实现XA模式</p><p>Seata的starter已经完成了XA模式的自动装配，实现非常简单，步骤如下：
修改application.yml文件（每个参与事务的微服务），开启XA模式：</p><div class=highlight id=id-1><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>配置seata的注册中心
</span></span><span style=display:flex><span>seata:
</span></span><span style=display:flex><span>  data-source-proxy-mode: XA # 选择XA模式</span></span></code></pre></div><p>注意：是每一个微服务都需要</p><p>给发起全局事务的入口方法添加@GlobalTransactional注解，本例中是OrderServiceImpl中的create方法：</p><p>启动所有微服务，postman进行接口测试</p><p>先进行正确的测试，再继续错误的测试</p><blockquote><p>错误设置，购买商品超出原来剩余的商品数就会让数据库报错测试是否可以事务回滚</p></blockquote><p>注意：如果测试接口报错响应时间过长，那么就应该设置响应的时间大一点，如下图，然后重启seata</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220912891.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220912891.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220912891.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220912891.png 2x" sizes=auto data-title=image-20230126220912891 data-alt=image-20230126220912891 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>成功的可以查看seate的控制输出，可以看到事务回滚</p><p>IDEA输出</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220944119.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220944119.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220944119.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126220944119.png 2x" sizes=auto data-title=image-20230126220944119 data-alt=image-20230126220944119 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>查看数据库的数据是否有被更新</p><h3 id=2at模式>2、AT模式</h3><h4 id=21-at模式同样是分阶段提交的事务模型不过缺弥补了xa模型中资源锁定周期过长的缺陷>2.1、 AT模式同样是分阶段提交的事务模型，不过缺弥补了XA模型中资源锁定周期过长的缺陷。</h4><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221049428.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221049428.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221049428.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221049428.png 2x" sizes=auto data-title=image-20230126221049428 data-alt=image-20230126221049428 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><strong>阶段一RM的工作</strong>：</p><p>注册分支事务
记录undo-log（数据快照，JSON格式）
执行业务sql并提交
报告事务状态</p><p><strong>阶段二提交时RM的工作</strong>：</p><p>删除undo-log即可</p><p><strong>阶段二回滚时RM的工作</strong>：</p><p>根据undo-log恢复数据到更新前</p><p>执行示例
例如，一个分支业务的SQL是这样的：update tb_account set money = money - 10 where id = 1</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221227467.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221227467.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221227467.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221227467.png 2x" sizes=auto data-title=image-20230126221227467 data-alt=image-20230126221227467 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><strong>AT模式与XA模式最大的区别是什么</strong></p><p>XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交，不锁定资源。
XA模式依赖数据库机制实现回滚；AT模式利用数据快照实现数据回滚。
XA模式强一致；AT模式最终一致</p><h4 id=22at模式的脏写问题>2.2、AT模式的脏写问题</h4><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221354825.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221354825.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221354825.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221354825.png 2x" sizes=auto data-title=image-20230126221354825 data-alt=image-20230126221354825 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h4 id=23at模式的写隔离>2.3、AT模式的写隔离</h4><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221551524.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221551524.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221551524.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221551524.png 2x" sizes=auto data-title=image-20230126221551524 data-alt=image-20230126221551524 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h4 id=24at模式的优缺点>2.4、AT模式的优缺点</h4><p><strong>优点：</strong></p><ol><li>一阶段完成直接提交事务，释放数据库资源，性能比较好</li><li>利用全局锁实现读写隔离</li><li>没有代码侵入，框架自动完成回滚和提交</li></ol><p><strong>缺点：</strong></p><ol><li>两阶段之间属于软状态，属于最终一致</li><li>框架的快照功能会影响性能，但比XA模式要好很多</li></ol><h4 id=25实现at模式>2.5、实现AT模式</h4><p>AT模式中的快照生成、回滚等动作都是由框架自动完成，没有任何代码侵入，因此实现非常简单。</p><p>1、创建相关的数据库文件</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221859755.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221859755.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221859755.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221859755.png 2x" sizes=auto data-title=image-20230126221859755 data-alt=image-20230126221859755 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>lock_table（全局锁）表导入到TC服务关联的数据库</p><div class=highlight id=id-2><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#a2f;font-weight:700>DROP</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>IF</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>EXISTS</span><span style=color:#bbb> </span><span style=color:#666>`</span>lock_table<span style=color:#666>`</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>lock_table<span style=color:#666>`</span><span style=color:#bbb>  </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>row_key<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>128</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>xid<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>96</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>transaction_id<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>bigint</span>(<span style=color:#666>20</span>)<span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>branch_id<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>bigint</span>(<span style=color:#666>20</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>resource_id<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>256</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>table_name<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>32</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>pk<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>36</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>gmt_create<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>datetime</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>gmt_modified<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>datetime</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>KEY</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>row_key<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>USING</span><span style=color:#bbb> </span>BTREE,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>INDEX</span><span style=color:#bbb> </span><span style=color:#666>`</span>idx_branch_id<span style=color:#666>`</span>(<span style=color:#666>`</span>branch_id<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>USING</span><span style=color:#bbb> </span>BTREE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#a2f>ENGINE</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>InnoDB<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span>ROW_FORMAT<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Compact;</span></span></code></pre></div><p>undo_log（记录快照）表导入到微服务关联的数据库</p><div class=highlight id=id-3><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#a2f;font-weight:700>DROP</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>IF</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>EXISTS</span><span style=color:#bbb> </span><span style=color:#666>`</span>undo_log<span style=color:#666>`</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>undo_log<span style=color:#666>`</span><span style=color:#bbb>  </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>branch_id<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>bigint</span>(<span style=color:#666>20</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;branch transaction id&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>xid<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>100</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;global transaction id&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>context<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>128</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;undo_log context,such as serialization&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>rollback_info<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>longblob</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;rollback info&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>log_status<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>int</span>(<span style=color:#666>11</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;0:normal status,1:defense status&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>log_created<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>datetime</span>(<span style=color:#666>6</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;create datetime&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>log_modified<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>datetime</span>(<span style=color:#666>6</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;modify datetime&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>UNIQUE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>INDEX</span><span style=color:#bbb> </span><span style=color:#666>`</span>ux_undo_log<span style=color:#666>`</span>(<span style=color:#666>`</span>xid<span style=color:#666>`</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>branch_id<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>USING</span><span style=color:#bbb> </span>BTREE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#a2f>ENGINE</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>InnoDB<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;AT transaction mode undo table&#39;</span><span style=color:#bbb> </span>ROW_FORMAT<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Compact;</span></span></code></pre></div><p>2、修改application.yml文件，将事务模式修改为AT模式即可：</p><div class=highlight id=id-4><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#配置seata的注册中心
</span></span><span style=display:flex><span>seata:
</span></span><span style=display:flex><span>  data-source-proxy-mode: AT #选择XA模式</span></span></code></pre></div><p>3、重启并测试</p><p>查看当前的数据库库存数量继续超库存创建订单进行执行错误回滚测试</p><p>查看IDEA的错误日志</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221956361.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221956361.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221956361.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126221956361.png 2x" sizes=auto data-title=image-20230126221956361 data-alt=image-20230126221956361 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=3tcc模式>3、TCC模式</h3><h4 id=31tcc模式原理>3.1、tcc模式原理</h4><p>TCC模式与AT模式非常相似，每阶段都是独立事务，不同的是TCC通过人工编码来实现数据恢复。需要实现三个方法：</p><p><strong>Try：资源的检测和预留；</strong>
<strong>Confirm：完成资源操作业务；要求 Try 成功 Confirm 一定要能成功。</strong>
<strong>Cancel：预留资源释放，可以理解为try的反向操作。</strong>
举例，一个扣减用户余额的业务。假设账户A原来余额是100，需要余额扣减30元。</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222108140.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222108140.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222108140.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222108140.png 2x" sizes=auto data-title=image-20230126222108140 data-alt=image-20230126222108140 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>TCC的工作模型图：</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222214788.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222214788.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222214788.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126222214788.png 2x" sizes=auto data-title=image-20230126222214788 data-alt=image-20230126222214788 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h4 id=32小结>3.2、小结</h4><p>TCC模式的优点：</p><ol><li>一阶段完成直接提交事务，释放数据库资源，性能好</li><li>相比AT模型，无需生成快照，无需使用全局锁，性能最强</li><li>不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库</li></ol><p>TCC模式的缺点：</p><ol><li>有代码侵入，需要人为编写try、Confirm和Cancel接口，太麻烦</li><li>软状态，事务是最终一致</li><li>需要考虑Confirm和Cancel的失败情况，做好幂等处理</li></ol><h4 id=32tcc模式实现案例>3.2、TCC模式实现案例</h4><p>不是所有的业务都适合TCC模式，如库存，金额等就比较适合</p><p>改造account-service服务，利用TCC实现分布式事务</p><p>需求如下：</p><p>修改account-service，编写try、confirm、cancel逻辑：</p><ol><li>try业务：添加冻结金额，扣减可用金额</li><li>confirm业务：删除冻结金额</li><li>cancel业务：删除冻结金额，恢复可用金额</li></ol><p>保证confirm、cancel接口的幂等性允许空回滚拒绝业务悬挂</p><p><strong>TCC的空回滚和业务悬挂</strong></p><p>当某分支事务的try阶段阻塞时，可能导致全局事务超时而触发二阶段的cancel操作。在未执行try操作时先执</p><p>行了cancel操作，这时cancel不能做回滚，就是空回滚。</p><p>对于已经空回滚的业务，如果以后继续执行try，就永远不可能confirm或cancel，这就是业务悬挂。应当阻止</p><p>执行空回滚后的try操作，避免悬挂</p><p><strong>业务分析</strong></p><p>为了实现空回滚、防止业务悬挂，以及幂等性要求。我们必须在数据库记录冻结金额的同时，记录当前事务id和执行状态，为此我们设计了一张表（添加在微服务的数据库seata-demo中）：</p><div class=highlight id=id-5><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#a2f;font-weight:700>DROP</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>IF</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>EXISTS</span><span style=color:#bbb> </span><span style=color:#666>`</span>account_freeze_tbl<span style=color:#666>`</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>account_freeze_tbl<span style=color:#666>`</span><span style=color:#bbb>  </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>xid<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>128</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>user_id<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>varchar</span>(<span style=color:#666>255</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>freeze_money<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>int</span>(<span style=color:#666>11</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>UNSIGNED</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#666>0</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#666>`</span>state<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>int</span>(<span style=color:#666>1</span>)<span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>DEFAULT</span><span style=color:#bbb> </span><span style=color:#800>NULL</span><span style=color:#bbb> </span>COMMENT<span style=color:#bbb> </span><span style=color:#b44>&#39;事务状态，0:try，1:confirm，2:cancel&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a2f;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>KEY</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>xid<span style=color:#666>`</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>USING</span><span style=color:#bbb> </span>BTREE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#a2f>ENGINE</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>InnoDB<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CHARACTER</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>SET</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>utf8<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLLATE</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>utf8_general_ci<span style=color:#bbb> </span>ROW_FORMAT<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>COMPACT;</span></span></code></pre></div><p>Try业务：记录冻结金额和事务状态到account_freeze表，扣减account表可用金额</p><p>Confirm业务：根据xid删除account_freeze表的冻结记录</p><p>Cancel业务：修改account_freeze表，冻结金额为0，state为2，修改account表，恢复可用金额</p><p>如何判断是否空回滚：cancel业务中，根据xid查询account_freeze，如果为null则说明try还没做，需要空回</p><p>滚</p><p>如何避免业务悬挂：try业务中，根据xid查询account_freeze ，如果已经存在则证明Cancel已经执行，拒绝执</p><p>行try业务</p><p><strong>业务实现</strong></p><div class=highlight id=id-6><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#666>1</span><span>、声明</span>TCC<span>接口</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@BusinessActionContextParameter</span><span style=color:#666>()</span><span>注解的参数才可以被</span>BusinessActionContext<span>获取到</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>package</span> <span style=color:#00f;font-weight:700>cn.itcast.account.service</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.seata.rm.tcc.api.BusinessActionContext</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.seata.rm.tcc.api.BusinessActionContextParameter</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.seata.rm.tcc.api.LocalTCC</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.seata.rm.tcc.api.TwoPhaseBusinessAction</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * 项目名称：seata-demo
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * 描述：TCC实现接口
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   *
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * @author zhong
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * @date 2022-06-08 16:05
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   */</span>
</span></span><span style=display:flex><span>   <span style=color:#a2f>@LocalTCC</span>
</span></span><span style=display:flex><span>   <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>interface</span> <span style=color:#00f>AccountTCCService</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * 定义try,注释里面的值必须是与方法同名
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @param userId
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @param money
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>      */</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f>@TwoPhaseBusinessAction</span><span style=color:#666>(</span>name <span style=color:#666>=</span> <span style=color:#b44>&#34;deduct&#34;</span><span style=color:#666>,</span>commitMethod <span style=color:#666>=</span> <span style=color:#b44>&#34;confirm&#34;</span><span style=color:#666>,</span>rollbackMethod <span style=color:#666>=</span> <span style=color:#b44>&#34;cancel&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>      <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>deduct</span><span style=color:#666>(</span><span style=color:#a2f>@BusinessActionContextParameter</span><span style=color:#666>(</span>paramName <span style=color:#666>=</span> <span style=color:#b44>&#34;userId&#34;</span><span style=color:#666>)</span> String userId<span style=color:#666>,</span>
</span></span><span style=display:flex><span>              <span style=color:#a2f>@BusinessActionContextParameter</span><span style=color:#666>(</span>paramName <span style=color:#666>=</span> <span style=color:#b44>&#34;money&#34;</span><span style=color:#666>)</span><span style=color:#0b0;font-weight:700>int</span> money<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * 定义Confirm
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @param ctx 获取事务类型参数
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @return
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>      */</span>
</span></span><span style=display:flex><span>      <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>confirm</span><span style=color:#666>(</span>BusinessActionContext ctx<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * 定义Cancel
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @param ctx
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @return
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>      */</span>
</span></span><span style=display:flex><span>      <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>cancel</span><span style=color:#666>(</span>BusinessActionContext ctx<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      <span style=color:#666>}</span></span></span></code></pre></div><p>说明：对于account_freeze_tbl数据库表的操作与其他业务一样的，使用MP的CURD进行快速开发，需要实体类、mapper</p><p>2.、创建接口实现类</p><div class=highlight id=id-7><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>package</span> <span style=color:#00f;font-weight:700>cn.itcast.account.service.impl</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>cn.itcast.account.entity.AccountFreeze</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>cn.itcast.account.mapper.AccountFreezeMapper</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>cn.itcast.account.mapper.AccountMapper</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>cn.itcast.account.service.AccountTCCService</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.seata.core.context.RootContext</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.seata.rm.tcc.api.BusinessActionContext</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lombok.extern.slf4j.Slf4j</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>org.springframework.beans.factory.annotation.Autowired</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>org.springframework.stereotype.Service</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>org.springframework.transaction.annotation.Transactional</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * 项目名称：seata-demo
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * 描述：
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   *
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * @author zhong
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * @date 2022-06-08 16:25
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   */</span>
</span></span><span style=display:flex><span>   <span style=color:#a2f>@Slf4j</span>
</span></span><span style=display:flex><span>   <span style=color:#a2f>@Service</span>
</span></span><span style=display:flex><span>   <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>AccountTCCServiceImpl</span> <span style=color:#a2f;font-weight:700>implements</span> AccountTCCService <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * 注入可用余额dao
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>      */</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f>@Autowired</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>private</span> AccountMapper accountMapper<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * 注入冻结表dao
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>      */</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f>@Autowired</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>private</span> AccountFreezeMapper freezeMapper<span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * 资源检测和预留
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * 在数据库中设置了非负数字段限定，这里可以直接简化一步，如果为负数就会报错
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @param userId
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>    * @param money
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>      */</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f>@Transactional</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>deduct</span><span style=color:#666>(</span>String userId<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>int</span> money<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      <span style=color:#080;font-style:italic>// 获取全局事务id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>      String xid <span style=color:#666>=</span> RootContext<span style=color:#666>.</span><span style=color:#b44>getXID</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>      <span style=color:#080;font-style:italic>// 业务悬挂判断，如果freeze中有冻结记录，一定是CANCEL执行过，我要拒绝业务
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>      AccountFreeze accountFreeze <span style=color:#666>=</span> freezeMapper<span style=color:#666>.</span><span style=color:#b44>selectById</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>if</span><span style=color:#666>(</span>accountFreeze <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>){</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic>// 一定是CANCEL执行过，我要拒绝业务
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>          <span style=color:#a2f;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>      <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#080;font-style:italic>// 1、扣减可用余额
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>      accountMapper<span style=color:#666>.</span><span style=color:#b44>deduct</span><span style=color:#666>(</span>userId<span style=color:#666>,</span>money<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      <span style=color:#080;font-style:italic>// 2、记录冻结金额，事务状态
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>      AccountFreeze freeze <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> AccountFreeze<span style=color:#666>();</span>
</span></span><span style=display:flex><span>      freeze<span style=color:#666>.</span><span style=color:#b44>setXid</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      freeze<span style=color:#666>.</span><span style=color:#b44>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      freeze<span style=color:#666>.</span><span style=color:#b44>setState</span><span style=color:#666>(</span>AccountFreeze<span style=color:#666>.</span><span style=color:#b44>State</span><span style=color:#666>.</span><span style=color:#b44>TRY</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>      freeze<span style=color:#666>.</span><span style=color:#b44>setFreezeMoney</span><span style=color:#666>(</span>money<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      freezeMapper<span style=color:#666>.</span><span style=color:#b44>insert</span><span style=color:#666>(</span>freeze<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>   <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>confirm</span><span style=color:#666>(</span>BusinessActionContext ctx<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 1、获取事务id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       String xid <span style=color:#666>=</span> ctx<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 2、根据事务id删除冻结数据
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       <span style=color:#0b0;font-weight:700>int</span> count <span style=color:#666>=</span> freezeMapper<span style=color:#666>.</span><span style=color:#b44>deleteById</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>       <span style=color:#a2f;font-weight:700>return</span> count <span style=color:#666>==</span> <span style=color:#666>1</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>   <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a2f>@Override</span>
</span></span><span style=display:flex><span>   <span style=color:#a2f;font-weight:700>public</span> <span style=color:#0b0;font-weight:700>boolean</span> <span style=color:#00a000>cancel</span><span style=color:#666>(</span>BusinessActionContext ctx<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 0、查询冻结记录
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       String xid <span style=color:#666>=</span> ctx<span style=color:#666>.</span><span style=color:#b44>getXid</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 获取用户id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       String userId <span style=color:#666>=</span> ctx<span style=color:#666>.</span><span style=color:#b44>getActionContext</span><span style=color:#666>(</span><span style=color:#b44>&#34;userId&#34;</span><span style=color:#666>).</span><span style=color:#b44>toString</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>       AccountFreeze freeze <span style=color:#666>=</span> freezeMapper<span style=color:#666>.</span><span style=color:#b44>selectById</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 空回滚的判断，为null代表没有try没有执行
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       <span style=color:#a2f;font-weight:700>if</span><span style=color:#666>(</span>freeze <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>){</span>
</span></span><span style=display:flex><span>           freeze <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> AccountFreeze<span style=color:#666>();</span>
</span></span><span style=display:flex><span>           freeze<span style=color:#666>.</span><span style=color:#b44>setXid</span><span style=color:#666>(</span>xid<span style=color:#666>);</span>
</span></span><span style=display:flex><span>           freeze<span style=color:#666>.</span><span style=color:#b44>setUserId</span><span style=color:#666>(</span>userId<span style=color:#666>);</span>
</span></span><span style=display:flex><span>           freeze<span style=color:#666>.</span><span style=color:#b44>setState</span><span style=color:#666>(</span>AccountFreeze<span style=color:#666>.</span><span style=color:#b44>State</span><span style=color:#666>.</span><span style=color:#b44>CANCEL</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>           freeze<span style=color:#666>.</span><span style=color:#b44>setFreezeMoney</span><span style=color:#666>(</span><span style=color:#666>0</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>           freezeMapper<span style=color:#666>.</span><span style=color:#b44>insert</span><span style=color:#666>(</span>freeze<span style=color:#666>);</span>
</span></span><span style=display:flex><span>       <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 幂等判断
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       <span style=color:#a2f;font-weight:700>if</span><span style=color:#666>(</span>freeze<span style=color:#666>.</span><span style=color:#b44>getState</span><span style=color:#666>()</span> <span style=color:#666>==</span> AccountFreeze<span style=color:#666>.</span><span style=color:#b44>State</span><span style=color:#666>.</span><span style=color:#b44>CANCEL</span><span style=color:#666>){</span>
</span></span><span style=display:flex><span>           <span style=color:#080;font-style:italic>// 已经执行过了一次CANCEL，无需重复处理
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>           <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>       <span style=color:#666>}</span>
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 1、恢复可用余额
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       accountMapper<span style=color:#666>.</span><span style=color:#b44>refund</span><span style=color:#666>(</span>freeze<span style=color:#666>.</span><span style=color:#b44>getUserId</span><span style=color:#666>(),</span> freeze<span style=color:#666>.</span><span style=color:#b44>getFreezeMoney</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>       <span style=color:#080;font-style:italic>// 2、将冻结金额清零，修改状态
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>       freeze<span style=color:#666>.</span><span style=color:#b44>setFreezeMoney</span><span style=color:#666>(</span><span style=color:#666>0</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>       freeze<span style=color:#666>.</span><span style=color:#b44>setState</span><span style=color:#666>(</span>AccountFreeze<span style=color:#666>.</span><span style=color:#b44>State</span><span style=color:#666>.</span><span style=color:#b44>CANCEL</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>       <span style=color:#0b0;font-weight:700>int</span> count <span style=color:#666>=</span> freezeMapper<span style=color:#666>.</span><span style=color:#b44>updateById</span><span style=color:#666>(</span>freeze<span style=color:#666>);</span>
</span></span><span style=display:flex><span>       <span style=color:#a2f;font-weight:700>return</span> count <span style=color:#666>==</span> <span style=color:#666>1</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#666>}</span>
</span></span><span style=display:flex><span>   <span style=color:#666>}</span></span></span></code></pre></div><p>3、修改业务层连接方式
改为上面定义的TCCM业务实现</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/93b574a9f6a4408cb371dfd1d3c4a5bc.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/93b574a9f6a4408cb371dfd1d3c4a5bc.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/93b574a9f6a4408cb371dfd1d3c4a5bc.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/93b574a9f6a4408cb371dfd1d3c4a5bc.png 2x" sizes=auto data-title=img data-alt=img style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>4、测试数据
直接测试错误的信息</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223228185.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223228185.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223228185.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223228185.png 2x" sizes=auto data-title=image-20230126223228185 data-alt=image-20230126223228185 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>当出现错误的时候会将会数据保存到数据库，如果是成功的那么就会删除</p><p>IDEA的报错输出</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223248820.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223248820.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223248820.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223248820.png 2x" sizes=auto data-title=image-20230126223248820 data-alt=image-20230126223248820 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>4、SAGA模式</p><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223308411.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223308411.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223308411.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223308411.png 2x" sizes=auto data-title=image-20230126223308411 data-alt=image-20230126223308411 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>Saga模式是SEATA提供的长事务解决方案。也分为两个阶段：</p><p>一阶段：直接提交本地事务
二阶段：成功则什么都不做；失败则通过编写补偿业务来回滚
Saga模式优点：</p><ol><li><p>事务参与者可以基于事件驱动实现异步调用，吞吐高</p></li><li><p>一阶段直接提交事务，无锁，性能好</p></li><li><p>不用编写TCC中的三个阶段，实现简单</p></li></ol><p>缺点：</p><ol><li>软状态持续时间不确定，时效性差</li><li>没有锁，没有事务隔离，会有脏写</li></ol><p><img loading=lazy src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223410575.png srcset="https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223410575.png, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223410575.png 1.5x, https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230126223410575.png 2x" sizes=auto data-title=image-20230126223410575 data-alt=image-20230126223410575 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.115.4">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><div id=mask></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script src=/js/theme.min.js defer></script></body></html>