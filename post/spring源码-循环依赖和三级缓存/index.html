<!doctype html><html lang=zh-cn dir=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>Spring源码-循环依赖和三级缓存 - 想学啊你</title><meta name=keywords content="博客"><meta name=author content="roam"><meta property="og:title" content="Spring源码-循环依赖和三级缓存"><meta property="og:site_name" content="想学啊你"><meta property="og:image" content="https://codingroam.github.io/img/author.jpg"><meta name=title content="Spring源码-循环依赖和三级缓存 - 想学啊你"><meta name=description content="轻轻的你来了"><link rel="shortcut icon" href=https://codingroam.github.io/img/favicon.ico><link rel=apple-touch-icon href=https://codingroam.github.io/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=https://codingroam.github.io/img/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=https://codingroam.github.io/css/main.css rel=stylesheet type=text/css><link href=https://codingroam.github.io/css/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-Hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>想学啊你</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>三四楼那么高了</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class=menu-item><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-book"></i><br>分类</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://codingroam.github.io/post/spring%E6%BA%90%E7%A0%81-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%92%8C%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/ itemprop=url>Spring源码-循环依赖和三级缓存</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2023-01-30">2023-01-30</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/spring itemprop=url rel=index><span itemprop=name>Spring</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>7975 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>16分钟</span></span>
<span id=/post/spring%E6%BA%90%E7%A0%81-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%92%8C%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/ class="leancloud_visitors post-visitor" data-flag-title=Spring源码-循环依赖和三级缓存><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><p>Spring源码（循环依赖和三级缓存）</p><p>目录
循环依赖 多级缓存 一级缓存 二级缓存 当循环依赖遇上AOP 三级缓存 Spring三级缓存源码实现 总结</p><p>  BeanFactory作为bean工厂管理我们的单例bean，那么肯定需要有个缓存来存储这些单例bean，在Spring中就是一个Map结构的缓存，key为beanName，value为bean。在获取一个bean的时候，先从缓存中获取，如果没有获取到，那么触发对象的实例化和初始化操作，完成之后再将对象放入缓存中，这样就能实现一个简单的bean工厂。   由于Spring提供了依赖注入的功能，支持将一个对象自动注入到另一个对象的属性中，这就可能出现<strong>循环依赖</strong>（区别于dependsOn）的问题：A对象在创建的时候依赖于B对象，而B对象在创建的时候依赖于A对象。 <img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/20210518132315114.png alt=img>   可以看到，由于A依赖B，所以创建A的时候触发了创建B，而B又依赖A，又会触发获取A，但是此时A正在创建中，还不在缓存中，就引发了问题。</p><h2 id=一级缓存>一级缓存</h2><p>  前面引出了循环依赖的问题，那么该如何解决呢？其实很简单，单单依赖一级缓存就能解决。对于一级缓存，我们不再等对象初始化完成之后再存入缓存，而是等对象实例化完成后就存入一级缓存，由于此时缓存中的bean还没有进行初始化操作，可以称之为<strong>早期对象</strong>，也就是将A对象<strong>提前暴露</strong>了。这样B在创建过程中获取A的时候就能从缓存中获取到A对象，最后在A对象初始化工作完成后再更新一级缓存即可，这样就解决了循环依赖的问题。   但是这样又引出了另一个问题：早期对象和完整对象都存在于一级缓存中，如果此时来了其它线程并发获取bean，就可能从一级缓存中获取到不完整的bean，这明显不行，那么我们不得已只能在从一级缓存获取对象处加一个互斥锁，以避免这个问题。   而加互斥锁也带来了另一个问题，容器刷新完成后的普通获取bean的请求都需要竞争锁，如果这样处理，在高并发场景下使用spring的性能一定会极低。</p><h2 id=二级缓存>二级缓存</h2><p>  既然只依赖一级缓存解决循环依赖需要靠加锁来保证对象的安全发布，而加锁又会带来性能问题，那该如何优化呢？答案就是引入另一个缓存。这个缓存也是一个Map结构，key为beanName，value为bean，而这个缓存可以称为<strong>二级缓存</strong>。我们将早期对象存到二级缓存中，一级缓存还是用于存储完整对象（对象初始化工作完成后），这样在接下来B创建的过程中获取A的时候，先从一级缓存获取，如果一级缓存没有获取到，则从二级缓存获取，虽然从二级缓存获取的对象是早期对象，但是站在对象内存关系的角度来看，二级缓存中的对象和后面一级缓存中的对象（指针）都指向同一对象，区别是对象处于不同的阶段，所以不会有什么问题。   既然获取bean的逻辑是先从一级缓存获取，没有的话再从二级缓存获取，那么也可能出现其它线程获取到不完整对象的问题，所以还是需要加互斥锁。不过这里的加锁逻辑可以下沉到二级缓存，因为早期对象存储在二级缓存中，从一级缓存获取对象不用加锁，这样的话当容器初始化完成之后，普通的getBean请求可以直接从一级缓存获取对象，而不用去竞争锁。</p><h2 id=当循环依赖遇上aop>当循环依赖遇上AOP</h2><p>  似乎二级缓存已经解决了循环依赖的问题，看起来也非常简单，但是不要忘记Spring提供的另一种特性：AOP。Spring支持以CGLIB和JDK动态代理的方式为对象创建代理类以提供AOP支持，在前面总结bean生命周期的文章中已经提到过，代理对象的创建(通常)是在bean初始化完成之后进行（通过BeanPostProcessor后置处理器）的，而且按照正常思维来看，一个代理对象的创建也应该在原对象完整的基础上进行，但是当循环依赖遇上了AOP就不那么简单了。   还是在前面A和B相互依赖的场景中，试想一下如果A需要被代理呢？由于二级缓存中的早期对象是原对象，而代理对象是在A初始化完成之后再创建的，这就导致了B对象中引用的A对象不是代理对象，于是出现了问题。   要解决这问题也很简单，把代理对象提前创建不就行了？也就是如果没有循环依赖，那么代理对象还是在初始化完成后创建，如果有循环依赖，那么就提前创建代理对象。那么怎么判断发生了循环依赖呢？在B创建的过程中获取A的时候，发现二级缓存中有A，就说明发生了循环依赖，此时就为A创建代理对象，将其覆盖到二级缓存中，并且将代理对象复制给B的对应属性，解决了问题。当然，最终A初始化完成之后，在一级缓存中存放的肯定是代理对象。   如果在A和B相互依赖的基础上，还有一个对象C也依赖了A：A依赖B，B依赖A，A依赖C，C依赖A。那么在为A创建代理对象的时候，就要注意不能重复创建。</p><blockquote><p>可以在对象实例化完成之后，将其beanName存到一个Set结构中，标识对应的bean正在创建中，而当其他对象创建的过程依赖某个对象的时候，判断其是否在这个set中，如果在就说明发生了循环依赖。</p></blockquote><h2 id=三级缓存>三级缓存</h2><p>  虽然仅仅依靠二级缓存能够解决循环依赖和AOP的问题，但是从解决方案上看来，维护代理对象的逻辑和getBean的逻辑过于耦合，Spring没有采取这种方案，而是引入了另一个<strong>三级缓存</strong>。三级缓存的key还是为beanName，但是value是一个函数（ObjectFactory#getBean方法），在该函数中执行获取早期对象的逻辑：getEarlyBeanReference方法。 在getEarlyBeanReference方法中，Spring会调用所有SmartInstantiationAwareBeanPostProcessor的getEarlyBeanReference方法，通过该方法可以修改早期对象的属性或者替换早期对象。这个是Spring留给开发者的另一个扩展点，虽然我们很少使用，不过在循环依赖遇到AOP的时候，代理对象就是通过这个后置处理器创建。</p><p>  那么三级缓存在spring中是如何体现的呢？我们来到DefaultSingletonBeanRegistry中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#080;font-style:italic>//一级缓存，也就是单例池，存储最终对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>final</span> Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> singletonObjects <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> ConcurrentHashMap<span style=color:#666>&lt;&gt;(</span><span style=color:#666>256</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//二级缓存，存储早期对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>final</span> Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> Object<span style=color:#666>&gt;</span> earlySingletonObjects <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;(</span><span style=color:#666>16</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>//三级缓存，存储的是一个函数接口，
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>final</span> Map<span style=color:#666>&lt;</span>String<span style=color:#666>,</span> ObjectFactory<span style=color:#666>&lt;?&gt;&gt;</span> singletonFactories <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> HashMap<span style=color:#666>&lt;&gt;(</span><span style=color:#666>16</span><span style=color:#666>);</span>
</span></span></code></pre></div><p>  其实所谓三级缓存，在源码中就是3个Map，一级缓存用于存储最终单例对象，二级缓存用于存储早期对象，三级缓存用于存储函数接口。   在容器刷新时调用的十几个方法中，<strong>finishBeanFactoryInitialization</strong>方法主要用于实例化单例bean，在其逻辑中会冻结BeanDefinition的元数据，接着调用beanFactory的preInstantiateSingletons方法，循环所有被管理的beanName，依次创建Bean，我们这里主要关注创建bean的逻辑，也就是AbstractBeanFactory的doGetBean方法（该方法很长，这里只贴了<strong>部分代码</strong>）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>protected</span> <span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span> T <span style=color:#00a000>doGetBean</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>final</span> String name<span style=color:#666>,</span> <span style=color:#a2f>@Nullable</span> <span style=color:#a2f;font-weight:700>final</span> Class<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span> requiredType<span style=color:#666>,</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f>@Nullable</span> <span style=color:#a2f;font-weight:700>final</span> Object<span style=color:#666>[]</span> args<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>boolean</span> typeCheckOnly<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> BeansException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//解析FactoryBean的name(&amp;)和别名
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		<span style=color:#a2f;font-weight:700>final</span> String beanName <span style=color:#666>=</span> transformedBeanName<span style=color:#666>(</span>name<span style=color:#666>);</span>
</span></span><span style=display:flex><span>		Object bean<span style=color:#666>;</span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//尝试从缓存中获取对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		Object sharedInstance <span style=color:#666>=</span> getSingleton<span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>sharedInstance <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> args <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//包含了处理FactoryBean的逻辑，可以通过&amp;+beanName获取原对象，通过beanName获取真实对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#080;font-style:italic>//FactoryBean的真实bean有单独的缓存factoryBeanObjectCache（Map结构）存放
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#080;font-style:italic>//如果是普通的bean，那么直接返回对应的对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			bean <span style=color:#666>=</span> getObjectForBeanInstance<span style=color:#666>(</span>sharedInstance<span style=color:#666>,</span> name<span style=color:#666>,</span> beanName<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//只能解决单例对象的循环依赖
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>isPrototypeCurrentlyInCreation<span style=color:#666>(</span>beanName<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> BeanCurrentlyInCreationException<span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//如果存在父工厂，并且当前工厂中不存在对应的BeanDefinition，那么尝试到父工厂中寻找
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#080;font-style:italic>//比如spring mvc整合spring的场景
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			BeanFactory parentBeanFactory <span style=color:#666>=</span> getParentBeanFactory<span style=color:#666>();</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>parentBeanFactory <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#666>!</span>containsBeanDefinition<span style=color:#666>(</span>beanName<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#080;font-style:italic>//bean的原始名称
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>				String nameToLookup <span style=color:#666>=</span> originalBeanName<span style=color:#666>(</span>name<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>parentBeanFactory <span style=color:#a2f;font-weight:700>instanceof</span> AbstractBeanFactory<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>((</span>AbstractBeanFactory<span style=color:#666>)</span> parentBeanFactory<span style=color:#666>).</span><span style=color:#b44>doGetBean</span><span style=color:#666>(</span>
</span></span><span style=display:flex><span>							nameToLookup<span style=color:#666>,</span> requiredType<span style=color:#666>,</span> args<span style=color:#666>,</span> typeCheckOnly<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>else</span> <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>args <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>(</span>T<span style=color:#666>)</span> parentBeanFactory<span style=color:#666>.</span><span style=color:#b44>getBean</span><span style=color:#666>(</span>nameToLookup<span style=color:#666>,</span> args<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>return</span> parentBeanFactory<span style=color:#666>.</span><span style=color:#b44>getBean</span><span style=color:#666>(</span>nameToLookup<span style=color:#666>,</span> requiredType<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>				<span style=color:#080;font-style:italic>//处理dependsOn的依赖(不是循环依赖)
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>				String<span style=color:#666>[]</span> dependsOn <span style=color:#666>=</span> mbd<span style=color:#666>.</span><span style=color:#b44>getDependsOn</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>dependsOn <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>String dep <span style=color:#666>:</span> dependsOn<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>						<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>isDependent<span style=color:#666>(</span>beanName<span style=color:#666>,</span> dep<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>							<span style=color:#080;font-style:italic>//循环depends-on 抛出异常
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>							<span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> BeanCreationException<span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>getResourceDescription</span><span style=color:#666>(),</span> beanName<span style=color:#666>,</span>
</span></span><span style=display:flex><span>									<span style=color:#b44>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#666>+</span> beanName <span style=color:#666>+</span> <span style=color:#b44>&#34;&#39; and &#39;&#34;</span> <span style=color:#666>+</span> dep <span style=color:#666>+</span> <span style=color:#b44>&#34;&#39;&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>						<span style=color:#666>}</span>
</span></span><span style=display:flex><span>						registerDependentBean<span style=color:#666>(</span>dep<span style=color:#666>,</span> beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>						<span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>							getBean<span style=color:#666>(</span>dep<span style=color:#666>);</span>
</span></span><span style=display:flex><span>						<span style=color:#666>}</span>
</span></span><span style=display:flex><span>						<span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>NoSuchBeanDefinitionException ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>							<span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> BeanCreationException<span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>getResourceDescription</span><span style=color:#666>(),</span> beanName<span style=color:#666>,</span>
</span></span><span style=display:flex><span>									<span style=color:#b44>&#34;&#39;&#34;</span> <span style=color:#666>+</span> beanName <span style=color:#666>+</span> <span style=color:#b44>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#666>+</span> dep <span style=color:#666>+</span> <span style=color:#b44>&#34;&#39;&#34;</span><span style=color:#666>,</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>						<span style=color:#666>}</span>
</span></span><span style=display:flex><span>					<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#080;font-style:italic>//创建单例bean
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>isSingleton</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//把beanName 和一个ObjectFactory类型的singletonFactory传入getSingleton方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					<span style=color:#080;font-style:italic>//ObjectFactory是一个函数，最终创建bean的逻辑就是通过回调这个ObjectFactory的getObject方法完成的
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					sharedInstance <span style=color:#666>=</span> getSingleton<span style=color:#666>(</span>beanName<span style=color:#666>,</span> <span style=color:#666>()</span> <span style=color:#666>-&gt;</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>						<span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>							<span style=color:#080;font-style:italic>//真正创建bean的逻辑
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>							<span style=color:#a2f;font-weight:700>return</span> createBean<span style=color:#666>(</span>beanName<span style=color:#666>,</span> mbd<span style=color:#666>,</span> args<span style=color:#666>);</span>
</span></span><span style=display:flex><span>						<span style=color:#666>}</span>
</span></span><span style=display:flex><span>						<span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>BeansException ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>							destroySingleton<span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>							<span style=color:#a2f;font-weight:700>throw</span> ex<span style=color:#666>;</span>
</span></span><span style=display:flex><span>						<span style=color:#666>}</span>
</span></span><span style=display:flex><span>					<span style=color:#666>});</span>
</span></span><span style=display:flex><span>					bean <span style=color:#666>=</span> getObjectForBeanInstance<span style=color:#666>(</span>sharedInstance<span style=color:#666>,</span> name<span style=color:#666>,</span> beanName<span style=color:#666>,</span> mbd<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>BeansException ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				cleanupAfterBeanCreationFailure<span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>throw</span> ex<span style=color:#666>;</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>(</span>T<span style=color:#666>)</span> bean<span style=color:#666>;</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span></code></pre></div><p>  对于单例对象，调用doGetBean方法的时候会调用getSingleton方法，该方法的入参是beanName和一个ObjectFactory的函数，在getSingleton方法中通过回调ObjectFactory的getBean方法完成bean的创建，那我们来看看getSingleton方法(部分代码)：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> Object <span style=color:#00a000>getSingleton</span><span style=color:#666>(</span>String beanName<span style=color:#666>,</span> ObjectFactory<span style=color:#666>&lt;?&gt;</span> singletonFactory<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>		Assert<span style=color:#666>.</span><span style=color:#b44>notNull</span><span style=color:#666>(</span>beanName<span style=color:#666>,</span> <span style=color:#b44>&#34;Bean name must not be null&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//互斥锁
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span><span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>singletonObjects</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//首先尝试从尝试从单例缓存池中获取对象，如果获取到了对象则直接返回，否则进入创建的逻辑
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			Object singletonObject <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>singletonObjects</span><span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>singletonObject <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#080;font-style:italic>//在创建之前将要创建的beanName存入singletonsCurrentlyInCreation中，这个是一个Map结构，用于标识单例正在创建中
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>				beforeSingletonCreation<span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#0b0;font-weight:700>boolean</span> newSingleton <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>				<span style=color:#0b0;font-weight:700>boolean</span> recordSuppressedExceptions <span style=color:#666>=</span> <span style=color:#666>(</span><span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>suppressedExceptions</span> <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>recordSuppressedExceptions<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>suppressedExceptions</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> LinkedHashSet<span style=color:#666>&lt;&gt;();</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//回调singletonFactory的getObject方法，该函数在外层doGetBean方法中传入
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					<span style=color:#080;font-style:italic>//实际调用了createBean方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					singletonObject <span style=color:#666>=</span> singletonFactory<span style=color:#666>.</span><span style=color:#b44>getObject</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>					newSingleton <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span> <span style=color:#a2f;font-weight:700>finally</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>recordSuppressedExceptions<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>						<span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>suppressedExceptions</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>					<span style=color:#666>}</span>
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//将beanName从正在创建单例bean的集合singletonsCurrentlyInCreation中移除
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					afterSingletonCreation<span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>newSingleton<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//将创建好的单例bean放入一级缓存，并且从二级缓存、三级缓存中移除
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					<span style=color:#080;font-style:italic>//添加到registeredSingletons中
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					addSingleton<span style=color:#666>(</span>beanName<span style=color:#666>,</span> singletonObject<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>return</span> singletonObject<span style=color:#666>;</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span></code></pre></div><p>  getSingleton方法的主线逻辑很简单，就是通过传入的函数接口创建单例bean，然后存入一级缓存中，同时清理bean在二级缓存、三级缓存中对应的数据。前面已经分析过了，传入的函数接口调用的是createBean方法，那么我们又来到createBean方法，createBean方法主要调用doCreateBean方法，在doCreateBean调用之前会先调用nstantiationAwareBeanPostProcessor的<strong>postProcessBeforeInstantiation</strong>拦截bean的实例化，如果这里的后置处理器返回了bean，则不会到后面的doCreateBean方法中，不过我们这里不用关心这个逻辑，直接跳到doCreateBean方法（部分代码）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>protected</span> Object <span style=color:#00a000>doCreateBean</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>final</span> String beanName<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>final</span> RootBeanDefinition mbd<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>final</span> <span style=color:#a2f>@Nullable</span> Object<span style=color:#666>[]</span> args<span style=color:#666>)</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>throws</span> BeanCreationException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>		BeanWrapper instanceWrapper <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>isSingleton</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			instanceWrapper <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>factoryBeanInstanceCache</span><span style=color:#666>.</span><span style=color:#b44>remove</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>instanceWrapper <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//创建bean，也是就是实例化，会把实例化后的bean包装在BeanWrapper中
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			instanceWrapper <span style=color:#666>=</span> createBeanInstance<span style=color:#666>(</span>beanName<span style=color:#666>,</span> mbd<span style=color:#666>,</span> args<span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//eanWrapper中获取到对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		<span style=color:#a2f;font-weight:700>final</span> Object bean <span style=color:#666>=</span> instanceWrapper<span style=color:#666>.</span><span style=color:#b44>getWrappedInstance</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>		Class<span style=color:#666>&lt;?&gt;</span> beanType <span style=color:#666>=</span> instanceWrapper<span style=color:#666>.</span><span style=color:#b44>getWrappedClass</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>beanType <span style=color:#666>!=</span> NullBean<span style=color:#666>.</span><span style=color:#b44>class</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			mbd<span style=color:#666>.</span><span style=color:#b44>resolvedTargetType</span> <span style=color:#666>=</span> beanType<span style=color:#666>;</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>postProcessingLock</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>mbd<span style=color:#666>.</span><span style=color:#b44>postProcessed</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//MergedBeanDefinitionPostProcessor后置处理器的处理
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					applyMergedBeanDefinitionPostProcessors<span style=color:#666>(</span>mbd<span style=color:#666>,</span> beanType<span style=color:#666>,</span> beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> BeanCreationException<span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>getResourceDescription</span><span style=color:#666>(),</span> beanName<span style=color:#666>,</span>
</span></span><span style=display:flex><span>							<span style=color:#b44>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#666>,</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				mbd<span style=color:#666>.</span><span style=color:#b44>postProcessed</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>true</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//判断该对象是否支持提前暴露，核心条件就是要求单例对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		<span style=color:#0b0;font-weight:700>boolean</span> earlySingletonExposure <span style=color:#666>=</span> <span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>isSingleton</span><span style=color:#666>()</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>allowCircularReferences</span> <span style=color:#666>&amp;&amp;</span>
</span></span><span style=display:flex><span>				isSingletonCurrentlyInCreation<span style=color:#666>(</span>beanName<span style=color:#666>));</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>earlySingletonExposure<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//把我们的早期对象包装成一个singletonFactory对象 该对象提供了一个getObject方法,该方法内部调用getEarlyBeanReference方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#080;font-style:italic>//将早期对象存入三级缓存，三级缓存存的是一个接口实现（ObjectFactory接口），其getBean方法会调用getEarlyBeanReference方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			addSingletonFactory<span style=color:#666>(</span>beanName<span style=color:#666>,</span> <span style=color:#666>()</span> <span style=color:#666>-&gt;</span> getEarlyBeanReference<span style=color:#666>(</span>beanName<span style=color:#666>,</span> mbd<span style=color:#666>,</span> bean<span style=color:#666>));</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>// Initialize the bean instance.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		Object exposedObject <span style=color:#666>=</span> bean<span style=color:#666>;</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>try</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//属性赋值操作，这里就可能出现循环依赖问题
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			populateBean<span style=color:#666>(</span>beanName<span style=color:#666>,</span> mbd<span style=color:#666>,</span> instanceWrapper<span style=color:#666>);</span>
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//实例化操作：调用三个Aware、后置处理器beforeInitialization（包含@PostConstruct的实现）、afterPropertiesSet、init-method、后置处理器afterInitialization等
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#080;font-style:italic>//个方法里的后置处理器可能会改变exposeObject
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			exposedObject <span style=color:#666>=</span> initializeBean<span style=color:#666>(</span>beanName<span style=color:#666>,</span> exposedObject<span style=color:#666>,</span> mbd<span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>catch</span> <span style=color:#666>(</span>Throwable ex<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>ex <span style=color:#a2f;font-weight:700>instanceof</span> BeanCreationException <span style=color:#666>&amp;&amp;</span> beanName<span style=color:#666>.</span><span style=color:#b44>equals</span><span style=color:#666>(((</span>BeanCreationException<span style=color:#666>)</span> ex<span style=color:#666>).</span><span style=color:#b44>getBeanName</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>throw</span> <span style=color:#666>(</span>BeanCreationException<span style=color:#666>)</span> ex<span style=color:#666>;</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>throw</span> <span style=color:#a2f;font-weight:700>new</span> BeanCreationException<span style=color:#666>(</span>
</span></span><span style=display:flex><span>						mbd<span style=color:#666>.</span><span style=color:#b44>getResourceDescription</span><span style=color:#666>(),</span> beanName<span style=color:#666>,</span> <span style=color:#b44>&#34;Initialization of bean failed&#34;</span><span style=color:#666>,</span> ex<span style=color:#666>);</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>earlySingletonExposure<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//这里的入参为false,表示只从一级缓存和二级缓存中获取
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#080;font-style:italic>//非循环依赖的情况下，不会调用到三级缓存，三级缓存中的接口会在单例对象入一级缓存的时候移除
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			Object earlySingletonReference <span style=color:#666>=</span> getSingleton<span style=color:#666>(</span>beanName<span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>false</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>earlySingletonReference <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//如果获取到了早期暴露对象earlySingletonReference不为空
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>exposedObject <span style=color:#666>==</span> bean<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>						<span style=color:#080;font-style:italic>//如果exposeObject在经过initializeBean方法后没有改变，那么说明
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>						<span style=color:#080;font-style:italic>//没有被后置处理器修改，那么用earlySingletonReference替换exposeObject
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>						exposedObject <span style=color:#666>=</span> earlySingletonReference<span style=color:#666>;</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>return</span> exposedObject<span style=color:#666>;</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span></code></pre></div><p>  这个方法的逻辑就是先实例化对象，如果对象支持暴露早期对象，那么会将早期对象作为入参传入getEarlyBeanReference方法，然后包装成一个ObjectFactory存入三级缓存，接着再调用populateBean方法填充对象的属性。而在填充对象属性的过程中，就可能发现循环依赖，比如当前正在创建A，然后在populateBean方法中发现了依赖B，那么就会调用getBean(B)，B也会走上面A走的这个流程，当B也走到populateBean方法填充属性的时候，又发现依赖了A，那么又会调用getBean(A)。那么在populateBean创建A的时候，会从三级缓存中获取bean，如果A需要被代理，那么会创建代理对象，这样B中的A属性就是代理对象了，接着把三级缓存获取的对象存入二级缓存中。 在B处理完成之后就回到了A的逻辑，假设populateBean(A)的逻辑完成了，那么接着进入initializeBean方法进行A的初始化操作，注意这里执行初始化操作的对象是A原对象，代理对象存储在二级缓存中。由于initializeBean方法会调用后置处理器的before-afterInitialization方法，这个后置处理器可能会改变对象，所以在后面的逻辑中，如果从二级缓存中获取到了A的代理对象，会判断原对象经过后置处理器后有没有变化，如果还是原对象，那么用二级缓存中的代理对象覆盖原对象，所以doCreateBean方法返回的就是代理对象，最终存入一级缓存中。流程就是：创建A实例对象->设置A的B属性->创建B实例对象->设置B的A属性->创建A的代理对象存入二级缓存->初始化A对象->从二级缓存取出A的代理对象覆盖A对象->A的代理对象存入一级缓存   我们需要关注的就是在B的populateBean逻辑里调用getBean(A)是什么样的逻辑。当然也是getBean->doGetBean->getSingleton这个逻辑，我们着重关注一下getSingleton方法的实现：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>protected</span> Object <span style=color:#00a000>getSingleton</span><span style=color:#666>(</span>String beanName<span style=color:#666>,</span> <span style=color:#0b0;font-weight:700>boolean</span> allowEarlyReference<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//首先从一级缓存中获取
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		Object singletonObject <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>singletonObjects</span><span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>singletonObject <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> isSingletonCurrentlyInCreation<span style=color:#666>(</span>beanName<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#080;font-style:italic>//如果从一级缓存没有获取到，并且获取的对象正在创建中，这里已经能够确定发生了循环依赖
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>			<span style=color:#a2f;font-weight:700>synchronized</span> <span style=color:#666>(</span><span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>singletonObjects</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#080;font-style:italic>//为了防止其它线程获取到不完整工单对象，这里使用同步锁控制
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>				<span style=color:#080;font-style:italic>//从二级缓存中获取早期对象
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>				singletonObject <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>earlySingletonObjects</span><span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>singletonObject <span style=color:#666>==</span> <span style=color:#a2f;font-weight:700>null</span> <span style=color:#666>&amp;&amp;</span> allowEarlyReference<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//如果二级缓存中也没有获取到，且allowEarlyReference为true（这里传入的是true）
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					<span style=color:#080;font-style:italic>//那么尝试从三级缓存中获取
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					ObjectFactory<span style=color:#666>&lt;?&gt;</span> singletonFactory <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>singletonFactories</span><span style=color:#666>.</span><span style=color:#b44>get</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>					<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>singletonFactory <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>						<span style=color:#080;font-style:italic>//从三级缓存中获取到了对象，注意三级缓存存储的是ObjectFactory
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>						<span style=color:#080;font-style:italic>//调用getObject方法，前面提到了早期暴露的对象存入三级缓存的ObjectFactory的getBean方法调用
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>						<span style=color:#080;font-style:italic>//的是getEarlyBeanReference方法，所以这里会调用getEarlyBeanReference方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>						singletonObject <span style=color:#666>=</span> singletonFactory<span style=color:#666>.</span><span style=color:#b44>getObject</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>						<span style=color:#080;font-style:italic>//把早期对象存入二级缓存
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>						<span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>earlySingletonObjects</span><span style=color:#666>.</span><span style=color:#b44>put</span><span style=color:#666>(</span>beanName<span style=color:#666>,</span> singletonObject<span style=color:#666>);</span>
</span></span><span style=display:flex><span>						<span style=color:#080;font-style:italic>//三级缓存中的接口没用了，直接移除
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>						<span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>singletonFactories</span><span style=color:#666>.</span><span style=color:#b44>remove</span><span style=color:#666>(</span>beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>					<span style=color:#666>}</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>return</span> singletonObject<span style=color:#666>;</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span></code></pre></div><p>  在getSingleton方法的逻辑中，先从一级缓存获取，如果一级缓存没有找到，那么如果获取的bean正在创建中，则从二级缓存获取，如果二级缓存没有找到，那么从三级缓存获取，三级缓存中存的是ObjectFactory实现，最终会调用其getBean方法获取bean，然后存入二级缓存中，同时清除三级缓存。同时提供了一个allowEarlyReference参数控制是否能从三级缓存中获取。   对于循环依赖的情况，getBean(A)->存入正在创建缓存->存入三级缓存->populateBean(A)->getBean(B)->populateBean(B)->getBean(A)->getSingleton(A)，当在populateBean(B)的过程中调用getSingleton(A)的时候，明显一级缓存和二级缓存都为空，但是三级缓存不为空，所以会通过三级缓存获取bean，三级缓存的创建逻辑如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#0b0;font-weight:700>boolean</span> earlySingletonExposure <span style=color:#666>=</span> <span style=color:#666>(</span>mbd<span style=color:#666>.</span><span style=color:#b44>isSingleton</span><span style=color:#666>()</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#a2f;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#b44>allowCircularReferences</span> <span style=color:#666>&amp;&amp;</span>
</span></span><span style=display:flex><span>				isSingletonCurrentlyInCreation<span style=color:#666>(</span>beanName<span style=color:#666>));</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>earlySingletonExposure<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			addSingletonFactory<span style=color:#666>(</span>beanName<span style=color:#666>,</span> <span style=color:#666>()</span> <span style=color:#666>-&gt;</span> getEarlyBeanReference<span style=color:#666>(</span>beanName<span style=color:#666>,</span> mbd<span style=color:#666>,</span> bean<span style=color:#666>));</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span></code></pre></div><p>  所以我们直接来到getEarlyBeanReference方法获取早期对象：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>protected</span> Object <span style=color:#00a000>getEarlyBeanReference</span><span style=color:#666>(</span>String beanName<span style=color:#666>,</span> RootBeanDefinition mbd<span style=color:#666>,</span> Object bean<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>		Object exposedObject <span style=color:#666>=</span> bean<span style=color:#666>;</span>
</span></span><span style=display:flex><span>		<span style=color:#080;font-style:italic>//如果容器中有InstantiationAwareBeanPostProcessors后置处理器
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>		<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(!</span>mbd<span style=color:#666>.</span><span style=color:#b44>isSynthetic</span><span style=color:#666>()</span> <span style=color:#666>&amp;&amp;</span> hasInstantiationAwareBeanPostProcessors<span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>			<span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>BeanPostProcessor bp <span style=color:#666>:</span> getBeanPostProcessors<span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>(</span>bp <span style=color:#a2f;font-weight:700>instanceof</span> SmartInstantiationAwareBeanPostProcessor<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//找到SmartInstantiationAwareBeanPostProcessor后置处理器
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					SmartInstantiationAwareBeanPostProcessor ibp <span style=color:#666>=</span> <span style=color:#666>(</span>SmartInstantiationAwareBeanPostProcessor<span style=color:#666>)</span> bp<span style=color:#666>;</span>
</span></span><span style=display:flex><span>					<span style=color:#080;font-style:italic>//调用SmartInstantiationAwareBeanPostProcessor的getEarlyBeanReference方法
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>					exposedObject <span style=color:#666>=</span> ibp<span style=color:#666>.</span><span style=color:#b44>getEarlyBeanReference</span><span style=color:#666>(</span>exposedObject<span style=color:#666>,</span> beanName<span style=color:#666>);</span>
</span></span><span style=display:flex><span>				<span style=color:#666>}</span>
</span></span><span style=display:flex><span>			<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#666>}</span>
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>return</span> exposedObject<span style=color:#666>;</span>
</span></span><span style=display:flex><span>	<span style=color:#666>}</span>
</span></span></code></pre></div><p>  这个getEarlyBeanReference方法的逻辑很简单，但是非常重要，该方法主要就是对SmartInstantiationAwareBeanPostProcessor后置处理器的调用，而循环依赖时的AOP就是通过这个<strong>SmartInstantiationAwareBeanPostProcessor</strong>的<strong>getEarlyBeanReference</strong>方法实现的，相关的具体类是AnnotationAwareAspectJAutoProxyCreator，这个留待AOP原理分析的文章中详细说明。</p><p>  多级缓存并不只是为了解决循环依赖和AOP的问题，还考虑到了逻辑的分离、结构的扩展性和保证数据安全前提下的效率问题等。由于存在二级缓存提前暴露不完整对象的情况，所以为了防止getSingleton方法返回不完整的bean，在该方法中使用了synchronized加锁，而为了不影响容器刷新完成后正常获取bean，从一级缓存获取对象没有加锁，事实上也不用加锁，因为一级缓存中要么没有对象，要么就是完整的对象。   通常情况下，容器刷新会触发单例对象的实例化和初始化，大致流程如下：<img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230130143730546.png alt=image-20230130143730546>循环依赖发生在对象都属性赋值，也就是populateBean阶段，在对象实例化完成后将其包装成一个函数接口ObjectFactory存入三级缓存，通过getEarlyBeanReference方法触发SmartInstantiationAwareBeanPostProcessor后置处理器的执行，如果循环依赖遇上了AOP，那么就在这里进行处理。   这里每个单例对象实例化之后存入三级缓存，即使没有发生循环依赖，这个是为之后可能发生的循环依赖做准备，如果最终没有发生循环依赖，那么对象实例化之后，正常初始化，然后存入一级缓存即可，而在存入一级缓存的时候会清空二级和三级缓存。</p><p><img src=https://bucket-typora-kw.oss-cn-beijing.aliyuncs.com/typora-image/image-20230130144022403.png alt=image-20230130144022403></p></div><footer class=post-footer><div class=post-tags><a href=/tags/spring rel=tag title=Spring>#Spring#</a>
<a href=/tags/%e6%ba%90%e7%a0%81 rel=tag title=源码>#源码#</a>
<a href=/tags/learning rel=tag title=Learning>#Learning#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>Spring源码-循环依赖和三级缓存</p><p><span>链接：</span>https://codingroam.github.io/post/spring%E6%BA%90%E7%A0%81-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%92%8C%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98/</p><p><span>作者：</span>roam</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://codingroam.github.io/post/spring%E6%BA%90%E7%A0%81bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%80%BB%E7%BB%93/ rel=next title=Spring源码-Bean生命周期总结><i class="fa fa-chevron-left"></i> Spring源码-Bean生命周期总结</a></div><div class="post-nav-prev post-nav-item"><a href=https://codingroam.github.io/post/sql%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%E4%B8%80distinctgroup-by/ rel=prev title="Sql问题记录一（distinct、group by）">Sql问题记录一（distinct、group by）
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=roam><p class=site-author-name itemprop=name>roam</p><p class="site-description motion-element" itemprop=description>以为打得赢我啊你</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>72</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>26</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>50</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/wk123456/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://www.zhihu.com/ target=_blank title=知乎><i class="fa fa-fw fa-globe"></i>
知乎</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://nutzam.com/ title=Nutz target=_blank>Nutz</a></li><li class=links-of-blogroll-item><a href=https://jfinal.com/ title=JFinal target=_blank>JFinal</a></li><li class=links-of-blogroll-item><a href=http://wendal.net/ title=Wendal target=_blank>Wendal</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/learning>Learning
<sup>27</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/java>Java
<sup>11</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql
<sup>10</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6>中间件
<sup>10</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/golang>Golang
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/golang%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0>Golang编程学习
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/linux>Linux
<sup>8</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/problem-solving>Problem solving
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/redis>Redis
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker
<sup>6</sup></a></li></ul></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>想学啊你</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.115.4</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://gitee.com/ style=font-weight:700 target=_blank>Gitee 仓库</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=http://beian.miit.gov.cn target=_blank>粤 ICP 备 18047355 号</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=https://codingroam.github.io/js/search.js></script>
<script type=text/javascript src=https://codingroam.github.io/js/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".footer").outerHeight(!0),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var e,t,n,s,o=$(".header-inner").height()+10;$("#sidebar").css({"margin-top":o}).show(),t=parseInt($("#sidebar").css("margin-top")),n=parseInt($(".sidebar-inner").css("height")),e=t+n,s=$(".content-wrap").height(),s<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>const locale={placeholder:"欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^"};$(function(){detectIE()>0?$.getScript(document.location.protocol+"//unpkg.com/@waline/client@1.6.0/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,emoji:[],wordLimit:"200",uploadImage:!1,locale,requiredMeta:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>